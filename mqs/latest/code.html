<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Code :: Cemosis Docs</title>
    <link rel="canonical" href="https://feelpp.github.io/docs.cemosis.fr/mqs/latest/code.html">
    <meta name="generator" content="Antora 2.3.3">
    <link rel="stylesheet" href="../../_/css/site.css">
<link rel="icon" href="../../_/img/favicon.ico" type="image/x-icon">    
<script>!function(l,p){if(l.protocol!==p&&l.host=="docs.antora.org"){l.protocol=p}else if(/\.gitlab\.io$/.test(l.host)){l.replace(p+"//docs.antora.org"+l.pathname.substr(l.pathname.indexOf("/",1))+l.search+l.hash)}}(location,"https:")</script>






<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  messageStyle: "none",
  tex2jax: {
    inlineMath: [['$','$'], ['\\(','\\)']],
    displayMath: [['$$','$$'], ['\\[','\\]']],
    processEscapes: true,
    processEnvironments: true, 
    ignoreClass: "nostem|nolatexmath"
  },
  asciimath2jax: {
    delimiters: [["\\$", "\\$"]],
    ignoreClass: "nostem|noasciimath"
  },

  TeX: {
      Macros: {
      RR: "{\\mathbb R}",
      NN: "{\\mathbb N}",
      Nso: "{N_{\\mathrm{so}}}",
      Nma: "{N_{\\mathrm{ma}}}",
      Nno: "{N_{\\mathrm{no}}}",
      Ne: "{N_{\\mathrm{e}}}",
      Ilag: ["{\\mathcal{I}^{\\mathrm{lag}}_{#1}}",1],
      calTh: "{\\mathcal{T}_h}",
      Ck: ["{\\mathcal{C}^{#1}}",1],
      Pk: ["{\\mathcal{P}^{#1}}",1],
      Qk: ["{\\mathcal{Q}^{#1}}",1],
      Pch: ["{P^{#1}_{c,h}}",1],
      Pcho: ["{P^{#1}_{c,h,0}}",1],
      Qch: ["{Q^{#1}_{c,h}}",1],
      Ich: ["{\\mathcal{I}^{#1}_{c,h}#2}",2],
      poly: ["{\\mathbb{#1}}",1],
      nf: "{n_f}",
      ngeo: "{n_{\\mathrm{geo}}}",
      geo: "{\\mathrm{geo}}",
      card: ["{\\operatorname{card}(#1)}",1],
      dim: ["{\\operatorname{dim}(#1)}",1],
      opdim: "{\\operatorname{dim}}",
      card: ["{\\operatorname{card}(#1)}",1],
      poly: ["{\\mathbb{#1}",1],
      R: ["{\\mathbb{R}^{#1}}",1],
      set: ["{\\left\\{#1\\right\\}}",1],
      diam: "{\\operatorname{diam}}",
      jump: ["{[\\![ #1 ]\\!]}",1],
      Next: "{\\mathrm{n}}",
      essinf: "{\\operatorname{ess}\\, \\operatorname{inf}}",
      tr: "{\\operatorname{tr}}",
      Id: "{\\mathcal{I}}",
      disp: ["{\\mathbf{#1}}",1],
      stresst: ["{\\mathbf{\\sigma(#1)}}",1],
      deformt: ["{\\mathbf{\\varepsilon(#1)}}",1],
      domain: "{\\Omega}",
      prect: ["{\\left\\(#1\\right\\)}",1],
      ds: "",
      bold: ["{\\bf #1}",1],
      p: "{\\mathrm{p}}",
      q:"{\\mathbf{q}}",
      n:"{\\mathbf{n}}",
      T:"{\\mathcal{T}}",
      F:"{\\mathcal{F}}",
      P:"{\\mathcal{P}}",
      v:"{\\mathbf{v}}"
  },
  extensions: ["mhchem.js"] }
});
</script>
<!--<script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.3/MathJax.js?config=TeX-MML-AM_CHTML"></script>-->
<!-- <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML' async></script> -->
<script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS_CHTML'>
</script>
<!--<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.6.0/MathJax.js?config=TeX-MML-AM_HTMLorMML"></script>-->

<!--<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.9.0/katex.min.css" integrity="sha384-TEMocfGvRuD1rIAacqrknm5BQZ7W7uWitoih+jMNFXQIbNl16bO8OZmylH/Vi/Ei" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.9.0/katex.min.js" integrity="sha384-jmxIlussZWB7qCuB+PgKG1uLjjxbVVIayPJwi6cG6Zb4YKq0JIw+OMnkkEC7kYCq" crossorigin="anonymous"></script>-->

    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-65761593-2"></script>
    <script>function gtag(){dataLayer.push(arguments)};window.dataLayer=window.dataLayer||[];gtag('js',new Date());gtag('config','UA-65761593-2')</script>
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar  navbar-expand-sm bg-dark navbar-dark">
    <div class="navbar-brand">
      <div class="navbar-item">
         <!--  <a href="https://book.feelpp.org">Feel++ documentation</a> -->
           <a href="https://feelpp.github.io/docs.cemosis.fr">Cemosis Docs</a>
      </div>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://feelpp.github.io/docs.cemosis.fr">Home</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <div class="navbar-link">Docs</div>
          <div class="navbar-dropdown">
            <div class="navbar-item"><strong>Latest Version</strong></div>

            <!-- this code allow to manage ordering of navbar item -->
               
              <a class="navbar-item" href="/cemosis/latest/index.html"> Cemosis Documentation </a>
                  
              <a class="navbar-item" href="/antora-ui-default/index.html"> Cemosis Documentation UI </a>
                  
              <a class="navbar-item" href="/eye2brain/current/index.html"> Eye2Brain Manual </a>
                  
              <a class="navbar-item" href="/feelpp-cfd/latest/index.html"> Feel++ CFD </a>
                  
              <a class="navbar-item" href="/mqs/latest/index.html"> Feel++ Maxwell Quasi Static </a>
                  
              <a class="navbar-item" href="/hemotumpp/0.1/index.html"> HemoTum++ </a>
                  
              <a class="navbar-item" href="/ibat/latest/index.html"> IBat </a>
                  
              <a class="navbar-item" href="/msqab/0.1/index.html"> msqab </a>
                  
              <a class="navbar-item" href="/swimmer/latest/index.html"> Swimmer Docs </a>
               

            <hr class="navbar-divider">
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <div class="navbar-link">Feel++</div>
          <div class="navbar-dropdown">
            <div class="navbar-item"><strong>GitHub</strong></div>
            <a class="navbar-item" href="http://github.com/feelpp/feelpp">GitHub Repository</a>
            <a class="navbar-item" href="http://github.com/feelpp/feelpp/issues">GitHub Issue Tracker</a>
            <hr class="navbar-divider">
            <div class="navbar-item"><strong>Documentation</strong></div>
            <a class="navbar-item" href="http://docs.feelpp.org/user/">User Manual</a>
            <a class="navbar-item" href="http://docs.feelpp.org/dev/">Developer Manual</a>
            <a class="navbar-item" href="http://docs.feelpp.org/toolbox/">Toolbox Manual</a>
            
          </div>
        </div>
        <div class="primary-action">
            <form class="navbar-item search">
              <input type="text" placeholder="Search Cemosis Docs" class="query" id="search-query">
              <button type="button" class="search-btn"><i class="fas fa-search"></i></button>
            </form>
        </div>
        <div class="navbar-item">
          <a class="navbar-brand" href="https://join.slack.com/t/feelpp/shared_invite/zt-2qe0q9hw-4pVbhohCXUE6Po9Ma8dbiQ">
            <img src="/_/img/slack.png" alt="slack" style="width:30px;"></a>
        </div>
        <div class="navbar-item">
          <a class="navbar-brand"  href="http://docs.feelpp.org">
            <img src="/_/img/logoFeelpp.png" alt="Feel++" style="width:60px;">
          </a>
        </div>
        <div class="navbar-item">
          <a class="navbar-brand"  href="http://www.cemosis.fr">
            <img src="/_/img/logoCemosisTransparent.png" alt="Cemosis" style="width:60px;">
          </a>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="mqs" data-version="latest">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html">Feel++ Maxwell Quasi Static</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">MQS</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Outline of the project</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="front.html">Modeling the transient behavior of high field magnets</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="index.html">Introduction</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="formulation.html">Formulation</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="discretization.html">Discretization</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="implementation.html">Implementation</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="validation.html">Validations</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="conclusion.html">Conclusion</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="acknowledgments.html">Acknowledgments</a>
  </li>
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="code.html">Code</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="bibliography.html">Bibliography</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="appendix.html">Appendix</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Roadmap</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="roadmap.html">Roadmap</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">References</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#toolboxes:maxwell:mqs/README.adoc">Eddy Currents</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">MQS stage</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Outline of the project</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="stage/front.html">Modeling the transient behavior of high field magnets</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="stage/index.html">Introduction</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="stage/formulation.html">Maxwell&#8217;s equations and MQS approximation</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="stage/validation.html">Validations</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="stage/endimple.html">End of the project, beginning and objective of the stage</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="stage/results.html">Implementation of MQS equations and results</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="stage/bdf.html">Backward differentiation formula</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="stage/mqsheat.html">Add the heat equation</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="stage/resolution1.html">Linear resolution</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="stage/resolution2.html">Non-linear resolution</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="stage/appendix.html">Appendix</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Feel++ Maxwell Quasi Static</span>
    <span class="version">latest</span>
  </div>
  <ul class="components">
    <li class="component">
      <span class="title">Cemosis Documentation</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../cemosis/latest/index.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">Cemosis Documentation UI</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../antora-ui-default/index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">Eye2Brain Manual</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../eye2brain/current/index.html">current</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">Feel++ CFD</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../feelpp-cfd/latest/index.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component is-current">
      <span class="title">Feel++ Maxwell Quasi Static</span>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="index.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">HemoTum++</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../hemotumpp/0.1/index.html">0.1</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">IBat</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../ibat/latest/index.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">msqab</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../msqab/0.1/index.html">0.1</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">Swimmer Docs</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../swimmer/latest/index.html">latest</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../../cemosis/latest/index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">Feel++ Maxwell Quasi Static</a></li>
    <li>MQS</li>
    <li>Outline of the project</li>
    <li><a href="code.html">Code</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/feelpp/mqs/edit/master/docs/modules/ROOT/pages/code.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<h1 class="page">Code</h1>
<div class="sect1">
<h2 id="_first_equation_code"><a class="anchor" href="#_first_equation_code"></a>1. First equation code</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Below is the complete code for the first equation solving :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cpp hljs" data-lang="cpp">#include &lt;feel/feeldiscr/pch.hpp&gt;
#include &lt;feel/feelfilters/loadmesh.hpp&gt;
#include &lt;feel/feelfilters/exporter.hpp&gt;
#include &lt;feel/feelvf/vf.hpp&gt;

int main(int argc, char **argv)
{
        using namespace Feel;
        po::options_description options("Laplacian options");
        options.add_options()("hc", po::value&lt;std::string&gt;()-&gt;default_value("1"), "convective heat transfer coefficient")("Tinf", po::value&lt;std::string&gt;()-&gt;default_value("1"), "Temperature far from boundary");
        Environment env(_argc = argc, _argv = argv, _desc = options,
                        _about = about(_name = "test1",
                                       _author = "Feel++ Consortium",
                                       _email = "feelpp-devel@feelpp.org"));

        auto A0 = expr&lt;3, 1&gt;(soption(_name = "functions.a"));
        Feel::cout &lt;&lt; "A0=" &lt;&lt; A0 &lt;&lt; std::endl;

        auto gI = expr&lt;3, 1&gt;(soption(_name = "functions.i"));
        Feel::cout &lt;&lt; "gI=" &lt;&lt; gI &lt;&lt; std::endl;

        auto gO = expr&lt;3, 1&gt;(soption(_name = "functions.o"));
        Feel::cout &lt;&lt; "gO=" &lt;&lt; gO &lt;&lt; std::endl;

        auto gradV = expr&lt;3, 1&gt;(soption(_name = "functions.v"));
        Feel::cout &lt;&lt; "gradV=" &lt;&lt; gradV &lt;&lt; std::endl;

        auto Ad = expr&lt;3, 1&gt;(soption(_name = "functions.d"));
        Feel::cout &lt;&lt; "Ad=" &lt;&lt; Ad &lt;&lt; std::endl;

        auto mu = expr(soption(_name = "functions.m"));
        Feel::cout &lt;&lt; "mu=" &lt;&lt; mu &lt;&lt; std::endl;

        auto sigma = expr(soption(_name = "functions.s"));
        Feel::cout &lt;&lt; "sigma=" &lt;&lt; sigma &lt;&lt; std::endl;

        auto Aexact_g = expr&lt;3, 1&gt;(soption(_name = "functions.e"));
        Feel::cout &lt;&lt; "Aexact=" &lt;&lt; Aexact_g &lt;&lt; std::endl;

        double dt = doption(_name = "ts.time-step");
        std::cout &lt;&lt; "time-step=" &lt;&lt; dt &lt;&lt; std::endl;

        double tmax = doption(_name = "ts.time-final");
        std::cout &lt;&lt; "time-final=" &lt;&lt; tmax &lt;&lt; std::endl;

        auto mesh = loadMesh(_mesh = new Mesh&lt;Simplex&lt;3&gt;&gt;);
        auto cond_mesh = createSubmesh(mesh, markedelements(mesh, "Omega_C"));

        auto Ah = Pchv&lt;1&gt;(mesh);

        auto A = Ah-&gt;element(A0);

        auto phi = Ah-&gt;element();

        auto Aexact = Ah-&gt;element();

        auto l1 = form1(_test = Ah);

        double t = 0;

        auto e = exporter(_mesh = mesh);
        auto a1 = form2(_trial = Ah, _test = Ah);

        Aexact_g.setParameterValues({{"t", t}});
        Aexact = project(_space = Ah, _expr = Aexact_g);

        gradV.setParameterValues({{"t", t}});
        e-&gt;step(t)-&gt;add("A", A0);
        e-&gt;step(t)-&gt;add("Aexact", Aexact);
        e-&gt;save();

        double L2Aexact = normL2(_range = elements(mesh), _expr = Aexact_g);
        double H1error = 0;
        double L2error = 0;
        Feel::cout &lt;&lt; "H1 error at t = " &lt;&lt; t &lt;&lt; ": " &lt;&lt; H1error &lt;&lt; std::endl;
        Feel::cout &lt;&lt; "L2 error at t = " &lt;&lt; t &lt;&lt; ": " &lt;&lt; L2error &lt;&lt; std::endl;

        for (t = dt; t &lt; tmax; t += dt)
        {
                Aexact_g.setParameterValues({{"t", t}});
                Aexact = project(_space = Ah, _expr = Aexact_g);
                gradV.setParameterValues({{"t", t}});
                gO.setParameterValues({{"t", t}});
                gI.setParameterValues({{"t", t}});
                Ad.setParameterValues({{"t", t}});

                l1.zero();
                a1.zero();
                l1 = integrate(_range = elements(cond_mesh),
                               _expr = sigma * inner(id(phi), idv(A) - dt * gradV));
                a1 = integrate(_range = elements(mesh),
                               _expr = (dt / mu) * inner(curl(phi), curlt(A)));
                a1 += integrate(_range = elements(cond_mesh),
                                _expr = sigma * inner(id(phi), idt(A)));
                a1 += on(_range = markedfaces(mesh, "Gamma_I"), _rhs = l1, _element = phi,
                         _expr = gI);
                a1 += on(_range = markedfaces(mesh, "Gamma_O"), _rhs = l1, _element = phi,
                         _expr = gO);
                a1 += on(_range = markedfaces(mesh, "Gamma_C"), _rhs = l1, _element = phi,
                         _expr = Ad);

                a1.solve(_rhs = l1, _solution = A);

                e-&gt;step(t)-&gt;add("A", A);
                e-&gt;step(t)-&gt;add("Aexact", Aexact_g);
                e-&gt;save();

                L2Aexact = normL2(_range = elements(mesh), _expr = Aexact_g);
                L2error = normL2(elements(mesh), (idv(A) - idv(Aexact)));
                H1error = normH1(elements(mesh), _expr = (idv(A) - idv(Aexact)), _grad_expr = (gradv(A) - gradv(Aexact)));

                Feel::cout &lt;&lt; t &lt;&lt; "" &lt;&lt; L2error &lt;&lt; " " &lt;&lt; L2error / L2Aexact &lt;&lt; " " &lt;&lt; H1error &lt;&lt; std::endl;
        }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_second_equation"><a class="anchor" href="#_second_equation"></a>2. Second equation</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Below is the complete code for the second equation solving :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cpp hljs" data-lang="cpp">#include &lt;feel/feeldiscr/pch.hpp&gt;
#include &lt;feel/feelfilters/loadmesh.hpp&gt;
#include &lt;feel/feelfilters/exporter.hpp&gt;
#include &lt;feel/feelvf/vf.hpp&gt;


int main(int argc, char**argv )
{
     using namespace Feel;
    po::options_description options( "Laplacian options" );
    options.add_options()
      ( "hc", po::value&lt;std::string&gt;()-&gt;default_value( "1" ), "convective heat transfer coefficient" )
      ( "Tinf", po::value&lt;std::string&gt;()-&gt;default_value( "1" ), "Temperature far from boundary" );
     Environment env( _argc=argc, _argv=argv,_desc=options,
                      _about=about(_name="test2",
                                   _author="Feel++ Consortium",
                                   _email="feelpp-devel@feelpp.org"));

    auto V0 = expr(soption(_name = "functions.v"));
    Feel::cout &lt;&lt; "V0=" &lt;&lt; V0 &lt;&lt; std::endl;

    auto gI = expr(soption(_name="functions.i"));
    Feel::cout &lt;&lt; "gI=" &lt;&lt; gI &lt;&lt; std::endl;

    auto gO = expr(soption(_name="functions.o"));
    Feel::cout &lt;&lt; "gO=" &lt;&lt; gO &lt;&lt; std::endl;

    auto Ad = expr(soption(_name = "functions.d"));
    Feel::cout &lt;&lt; "Ad=" &lt;&lt; Ad &lt;&lt; std::endl;

    auto dA = expr&lt;3,1&gt;(soption(_name="functions.a"));
    Feel::cout &lt;&lt; "dA=" &lt;&lt; dA &lt;&lt; std::endl;

    auto sigma = expr(soption(_name="functions.s"));
    Feel::cout &lt;&lt; "sigma=" &lt;&lt; sigma &lt;&lt; std::endl;

    auto Vexact_g = expr(soption(_name = "functions.e"));
    Feel::cout &lt;&lt; "Vexact=" &lt;&lt; Vexact_g &lt;&lt; std::endl;

    double dt = doption(_name = "ts.time-step");
    std::cout &lt;&lt; "time-step=" &lt;&lt; dt &lt;&lt; std::endl;

    double tmax = doption(_name = "ts.time-final");
    std::cout &lt;&lt; "time-final=" &lt;&lt; tmax &lt;&lt; std::endl;

    auto mesh = loadMesh(_mesh=new Mesh&lt;Simplex&lt;3&gt;&gt;);
    auto cond_mesh = createSubmesh(mesh,markedelements(mesh,"Omega_C"));

    auto Ah = Pchv&lt;1&gt;( mesh );
    auto Vh = Pch&lt;1&gt;( cond_mesh );

    auto V = Vh-&gt;element(V0);
    auto psi = Vh-&gt;element();
    auto Vexact = Vh-&gt;element();

    auto a2 = form2( _trial=Vh, _test=Vh);
    auto l2 = form1( _test=Vh );
    auto e = exporter( _mesh=mesh );

    double t = 0;

    Vexact_g.setParameterValues({{"t", t}});
    Vexact = project(_space = Vh, _expr = Vexact_g);

    dA.setParameterValues({{"t", t}});
    e-&gt;step(t)-&gt;add("V", V0);
    e-&gt;step(t)-&gt;add("Vexact", Vexact);
    e-&gt;save();

    double L2Vexact = normL2(_range = elements(mesh), _expr = Vexact_g);
    double H1error = 0;
    double L2error = 0;
    Feel::cout &lt;&lt; "H1 error at t = " &lt;&lt; t &lt;&lt; ": " &lt;&lt; H1error &lt;&lt; std::endl;
    Feel::cout &lt;&lt; "L2 error at t = " &lt;&lt; t &lt;&lt; ": " &lt;&lt; L2error &lt;&lt; std::endl;

    for (t = dt; t &lt; tmax; t += dt){
        Vexact_g.setParameterValues({{"t", t}});
        Vexact = project(_space = Vh, _expr = Vexact_g);
        dA.setParameterValues({{"t", t}});
        gO.setParameterValues({{"t", t}});
        gI.setParameterValues({{"t", t}});
        Ad.setParameterValues({{"t", t}});

        l2.zero();
        a2.zero();

        l2 = integrate(_range=elements(cond_mesh),
                    _expr = sigma * inner( -dA, trans(grad(psi)) ));

        a2 = integrate(_range=elements(cond_mesh),
                    _expr = sigma * inner(gradt(V), grad(psi) ));

        a2 += on(_range=markedfaces(cond_mesh,"Gamma_I"), _rhs=l2, _element=psi,
                _expr= gI );
        a2 += on(_range=markedfaces(cond_mesh,"Gamma_O"), _rhs=l2, _element=psi,
                _expr= gO );
        a2 += on(_range=markedfaces(cond_mesh,"Gamma_C"), _rhs=l2, _element=psi,
                _expr= Ad );

        a2.solve(_rhs=l2,_solution=V);
        e-&gt;step(t)-&gt;add( "V", V);
        e-&gt;step(t)-&gt;add("Vexact", Vexact_g);
        e-&gt;save();

        L2Vexact = normL2(_range = elements(mesh), _expr = Vexact_g);
        L2error = normL2(elements(mesh), (idv(V) - idv(Vexact)));
        H1error = normH1(elements(mesh), _expr = (idv(V) - idv(Vexact)), _grad_expr = (gradv(V) - gradv(Vexact)));

        Feel::cout &lt;&lt; t &lt;&lt; "" &lt;&lt; L2error &lt;&lt; " " &lt;&lt; L2error / L2Vexact &lt;&lt; " " &lt;&lt; H1error &lt;&lt; std::endl;

    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_coupled_system"><a class="anchor" href="#_coupled_system"></a>3. Coupled system</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Below is the code for the coupled system solving, which doesnt work for the moment :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cpp hljs" data-lang="cpp">#include &lt;feel/feelcore/environment.hpp&gt;
#include &lt;feel/feelcore/checker.hpp&gt;

#include &lt;feel/feeldiscr/pch.hpp&gt;
#include &lt;feel/feelfilters/loadmesh.hpp&gt;
#include &lt;feel/feelfilters/exporter.hpp&gt;
#include &lt;feel/feelvf/vf.hpp&gt;

#include &lt;feel/feelalg/vectorblock.hpp&gt;
#include &lt;feel/feeldiscr/product.hpp&gt;
#include &lt;feel/feelvf/blockforms.hpp&gt;



int main(int argc, char**argv )
{
  using namespace Feel;
  po::options_description options( "MQS options" );
  options.add_options()
    ( "sigma", po::value&lt;std::string&gt;()-&gt;default_value( "1" ), "electrical conductivity" )
    ( "mu_mag", po::value&lt;std::string&gt;()-&gt;default_value( "1" ), "relative magnetic permeability" )
    ( "A0", po::value&lt;std::string&gt;()-&gt;default_value( "{0,0,0}" ), "initial A" )
    ( "V0", po::value&lt;std::string&gt;()-&gt;default_value( "0" ), "initial V" )
    ( "Aexact", po::value&lt;std::string&gt;()-&gt;default_value( "{0,0,0}" ), "exact A" )
    ( "Vexact", po::value&lt;std::string&gt;()-&gt;default_value( "0" ), "exact V" )
    ( "Ad", po::value&lt;std::string&gt;()-&gt;default_value( "{0,0,0}" ), "Ad" )
    ( "v0", po::value&lt;std::string&gt;()-&gt;default_value( "0" ), "v0" )
    ( "v1", po::value&lt;std::string&gt;()-&gt;default_value( "0" ), "v1" );

  Environment env( _argc=argc, _argv=argv,_desc=options,
		   _about=about(_name="mqs",
				_author="Feel++ Consortium",
				_email="feelpp-devel@feelpp.org"));

  // Dirichlet for Magnetic potential
  auto Ad = expr&lt;3,1&gt;(soption(_name="Ad"));
  Feel::cout &lt;&lt; "Ad=" &lt;&lt; Ad &lt;&lt; std::endl;

  // Dirichlet for electric potential
  auto v1 = expr(soption(_name="v1"));
  Feel::cout &lt;&lt; "v1=" &lt;&lt; v1 &lt;&lt; std::endl;

  auto v0 = expr(soption(_name="v0"));
  Feel::cout &lt;&lt; "vO=" &lt;&lt; v0 &lt;&lt; std::endl;

  //Recuperer time frame

  double dt = doption(_name = "ts.time-step");
  std::cout &lt;&lt; "time-step=" &lt;&lt; dt &lt;&lt; std::endl;

  double tmax = doption(_name = "ts.time-final");
  std::cout &lt;&lt; "time-final=" &lt;&lt; tmax &lt;&lt; std::endl;

  // Init solution for Magnetic Potential
  auto A0 = expr&lt;3,1&gt;(soption(_name="A0"));
  Feel::cout &lt;&lt; "A0=" &lt;&lt; A0 &lt;&lt; std::endl;

  // Init solution for Potential
  auto V0 = expr(soption(_name="V0"));
  Feel::cout &lt;&lt; "V0=" &lt;&lt; V0 &lt;&lt; std::endl;

  // Define sigma and mu
  auto sigma = expr(soption(_name = "sigma"));
  Feel::cout &lt;&lt; "sigma=" &lt;&lt; sigma &lt;&lt; std::endl;

  auto mur = expr(soption(_name = "mu_mag"));
  Feel::cout &lt;&lt; "mur=" &lt;&lt; mur &lt;&lt; std::endl;

  // Enforce a solution
  auto Aexact_g = expr&lt;3, 1&gt;(soption(_name = "Aexact"));
  Feel::cout &lt;&lt; "Aexact=" &lt;&lt; Aexact_g &lt;&lt; std::endl;

  auto Vexact_g = expr(soption(_name = "Vexact"));
  Feel::cout &lt;&lt; "Vexact=" &lt;&lt; Vexact_g &lt;&lt; std::endl;

  // Load Mesh and define Product space

  auto mesh = loadMesh(_mesh=new Mesh&lt;Simplex&lt;3&gt;&gt;);
  auto cond_mesh = createSubmesh(mesh,markedelements(mesh,"Omega_C"));

  auto Ah = Pchv&lt;1&gt;( mesh );
  auto Vh = Pch&lt;1&gt;( cond_mesh );

  auto A = Ah-&gt;element(A0);
  auto V = Vh-&gt;element(V0);

  auto Aexact = Ah-&gt;element();
  auto Vexact = Vh-&gt;element();

  auto phi = Ah-&gt;element();
  auto psi = Vh-&gt;element();

  auto Zh = product(Ah,Vh);
  auto U = Zh.element();
#if 0
  auto cAh = Zh[0_c];
  auto cVh = Zh[1_c];
#endif


  auto rhs = blockform1( Zh );
  auto lhs = blockform2( Zh );

  double t = 0;

  auto e = exporter( _mesh=mesh );

  Aexact_g.setParameterValues({{"t", t}});
  Aexact = project(_space = Ah, _expr = Aexact_g);

  Vexact_g.setParameterValues({{"t", t}});
  Vexact = project(_space = Vh, _expr = Vexact_g);

  e-&gt;step(t)-&gt;add("A", A0);
  e-&gt;step(t)-&gt;add("Aexact", Aexact);
  e-&gt;step(t)-&gt;add("V", V0);
  e-&gt;step(t)-&gt;add("Vexact", Vexact);
  e-&gt;save();

  double L2Aexact = normL2(_range = elements(mesh), _expr = Aexact_g);
  double H1Aerror = 0;
  double L2Aerror = 0;
  double L2Vexact = normL2(_range = elements(mesh), _expr = Vexact_g);
  double H1Verror = 0;
  double L2Verror = 0;

  auto mu0 = 4.e-7 * M_PI ; // SI Unit : H/m = m.kg/s2/A2

  for (t = dt; t &lt; tmax; t += dt){
    Aexact_g.setParameterValues({{"t", t}});
    Aexact = project(_space = Ah, _expr = Aexact_g);
    Vexact_g.setParameterValues({{"t", t}});
    Vexact = project(_space = Vh, _expr = Vexact_g);
    v0.setParameterValues({{"t", t}});
    v1.setParameterValues({{"t", t}});
    Ad.setParameterValues({{"t", t}});

    lhs.zero();
    rhs.zero();
    tic();
    // Ampere law: sigma dA/dt + rot(1/(mu-r*mu_0) rotA) + sigma grad(V) = Js
    lhs(0_c, 0_c) = integrate( _range=elements(mesh),
		     _expr = dt * inner(curl(phi) , curlt(A)) );
    lhs(0_c, 0_c) += integrate( _range=elements(cond_mesh),
		     _expr = mur * mu0 * sigma * inner(id(phi) , idt(A) ));

    lhs(0_c, 1_c) = integrate(_range=elements(cond_mesh),
         _expr = dt * mu0 * mur * sigma*inner(id(phi),trans(gradt(V))) );

    rhs(0_c) = integrate(_range=elements(cond_mesh),
                        _expr = mu0 * mur * sigma * inner(id(phi) , idv(A)));

    // Current conservation: div( -sigma grad(V) -sigma*dA/dt) = Qs
    lhs(1_c, 0_c) = integrate( _range=elements(cond_mesh),
			       _expr = sigma * inner(idt(A), trans(grad(psi))) );

    lhs(1_c, 1_c) = integrate( _range=elements(cond_mesh),
			       _expr = sigma * dt * inner(gradt(V), grad(psi)) );

    rhs(1_c) = integrate(_range=elements(cond_mesh),
                        _expr = sigma * inner(idv(A), trans(grad(psi))) );

    /* Add Boundary conditions */
#if 0
    lhs(0_c, 0_c) += on(_range=markedfaces(mesh,"Infty"), _rhs=rhs(0_c), _element=phi, _expr= Ad);
#endif

#if 1
    /* 1/4th of a torus + Air */
    lhs(0_c, 0_c) += on(_range=markedfaces(mesh,"V0"), _rhs=rhs(0_c), _element=phi, _expr= Ad);
    lhs(0_c, 0_c) += on(_range=markedfaces(mesh,"V1"), _rhs=rhs(0_c), _element=phi, _expr= Ad);
    lhs(0_c, 0_c) += on(_range=markedfaces(mesh,"Gamma_C"), _rhs=rhs(0_c), _element=phi, _expr= Ad);
#endif

    lhs(1_c, 1_c) += on(_range=markedfaces(cond_mesh,"V0"), _rhs=rhs(1_c), _element=psi, _expr= v0);
    lhs(1_c, 1_c) += on(_range=markedfaces(cond_mesh,"V1"), _rhs=rhs(1_c), _element=psi, _expr= v1);
    lhs(1_c, 1_c) += on(_range=markedfaces(cond_mesh,"Gamma_C"), _rhs=rhs(1_c), _element=psi, _expr= Vexact_g);
    toc("assembling", true);

    /* Solve */
    tic();
    lhs.solve(_rhs=rhs,_solution=U);
    toc("solve", true);

    tic();
    e-&gt;step(t)-&gt;add( "A", U(0_c));
    e-&gt;step(t)-&gt;add( "V", U(1_c));
    e-&gt;step(t)-&gt;add( "Aexact", Aexact);
    e-&gt;step(t)-&gt;add( "Vexact", Vexact);
    e-&gt;save();
    toc("export", true);

    L2Aexact = normL2(_range = elements(mesh), _expr = Aexact_g);
    L2Aerror = normL2(elements(mesh), (idv(U(0_c)) - idv(Aexact)));
    H1Aerror = normH1(elements(mesh), _expr = (idv(U(0_c)) - idv(Aexact)), _grad_expr = (gradv(U(0_c)) - gradv(Aexact)));

    Feel::cout &lt;&lt; "A error: " &lt;&lt; "t="&lt;&lt; t &lt;&lt; " " &lt;&lt; L2Aerror &lt;&lt; " " &lt;&lt; L2Aerror / L2Aexact &lt;&lt; " " &lt;&lt; H1Aerror &lt;&lt; std::endl;

    L2Vexact = normL2(_range = elements(mesh), _expr = Vexact_g);
    L2Verror = normL2(elements(mesh), (idv(U(1_c)) - idv(Vexact)));
    H1Verror = normH1(elements(mesh), _expr = (idv(U(1_c)) - idv(Vexact)), _grad_expr = (gradv(U(1_c)) - gradv(Vexact)));

    Feel::cout &lt;&lt; "V error: " &lt;&lt; "t="&lt;&lt; t &lt;&lt; " " &lt;&lt; L2Verror &lt;&lt; " " &lt;&lt; L2Verror / L2Vexact &lt;&lt; " " &lt;&lt; H1Verror &lt;&lt; std::endl;

    #if 0
    A = U(0_c);
    V = U(1_c);
    #endif
  }
}</code></pre>
</div>
</div>
</div>
</div>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>

  </div>
</main>
</div>
<footer class="footer">
  <div class="container">
    <div class="footer-links">
      <div class="col">
        <div class="footer-logo">
          <a href="https://www.cemosis.fr" class="icon">
            <img src="../../_/img/logoCemosisTransparent.png" alt="Cemosis">
          </a>
        </div>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://docs.cemosis.fr" target="_blank" rel="noopener">Projects Documentation</a></li>
          <li><a href="https://join.slack.com/t/feelpp/shared_invite/zt-2qe0q9hw-4pVbhohCXUE6Po9Ma8dbiQ" target="_blank" rel="noopener">Forums(Slack)</a></li>
        </ul>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://www.cemosis.fr" target="_blank" rel="noopener">Cemosis</a></li>
          <li><a href="https://www.cemosis.fr/news" target="_blank" rel="noopener">News</a></li>
          <li><a href="https://www.cemosis.fr/projects" target="_blank" rel="noopener">Projects</a></li>
        </ul>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://docs.feelpp.org" target="_blank" rel="noopener">Feel++ Documentation</a></li>
          <li><a href="http://docs.feelpp.org/user/">Get Started</a></li>
          <li><a href="http://docs.feelpp.org/user//install/distributions/">Downloads</a></li>
        </ul>
      </div>
      <div class="col">
        <ul class="social-icons">
          <li>
            <svg  width="14" height="14" viewBox="0 0 32 32"> <path id="facebook" class="cls-1" d="M29,0H3A2.652,2.652,0,0,0,0,3V29a2.652,2.652,0,0,0,3,3H16V18H12V14h4V12a6.452,6.452,0,0,1,6-6h4v4H22a2.151,2.151,0,0,0-2,2v2h6l-1,4H20V32h9a2.652,2.652,0,0,0,3-3V3A2.652,2.652,0,0,0,29,0Z"/></svg>
            <a href="https://www.facebook.com/cemosis.fr" class="icon">
            Facebook
            </a>
          </li>
          <li>
            <svg  width="14" height="14" viewBox="0 0 32.1 26.1"> <path id="twitter" class="cls-1" d="M32,7.1a11.836,11.836,0,0,1-3.8,1,6.462,6.462,0,0,0,2.9-3.6,12.606,12.606,0,0,1-4.2,1.6A6.492,6.492,0,0,0,22.1,4a6.594,6.594,0,0,0-6.6,6.6,7.719,7.719,0,0,0,.2,1.5A18.458,18.458,0,0,1,2.2,5.2a6.294,6.294,0,0,0-.9,3.3A6.765,6.765,0,0,0,4.2,14a6.109,6.109,0,0,1-3-.8v.1a6.543,6.543,0,0,0,5.3,6.4,4.678,4.678,0,0,1-1.7.2,4.869,4.869,0,0,1-1.2-.1,6.679,6.679,0,0,0,6.1,4.6,12.917,12.917,0,0,1-8.2,2.8,9.151,9.151,0,0,1-1.6-.1,18.438,18.438,0,0,0,10.1,3c12.1,0,18.7-10,18.7-18.7v-.8A13.336,13.336,0,0,0,32,7.2Z" transform="translate(0.1 -4)"/></svg>
            <a href="https://twitter.com/cemosis" class="icon">
              Twitter
            </a>
          </li>
          <li>
          <svg  width="14" height="14" viewBox="0 0 32 32"> <path id="linkedin" class="cls-1" d="M29,0H3A3.076,3.076,0,0,0,0,3V29a3.009,3.009,0,0,0,3,3H29a2.946,2.946,0,0,0,3-3V3A3.009,3.009,0,0,0,29,0ZM12,26H8V12h4ZM10,10a2,2,0,1,1,2-2A2.006,2.006,0,0,1,10,10ZM26,26H22V18a2,2,0,0,0-4,0v8H14V12h4v2.5c.8-1.1,2.1-2.5,3.5-2.5A4.736,4.736,0,0,1,26,17Z"/></svg>
              <a href="https://www.linkedin.com/company/cemosis" class="icon">
             Linkedin
            </a>
          </li>
        </ul>
      </div>
    </div>
    <div class="footer-terms">
      <div class="footer-terms-copyright">
          <span>© 2020 Cemosis, Université de Strasbourg</span>
      </div>
      <div class="footer-terms-links">
        <a href="https://www.cemosis.fr/terms-of-use">Terms of Use</a>
        <a href="https://www.cemosis.fr/privacy-policy">Privacy Policy</a>
        <a href="https://www.cemosis.fr/cookie-policy">Cookie Policy</a>
        <a href="https://www.cemosis.fr/support-policy">Support Policy</a>
      </div>
    </div>
  </div>
</footer>
<script src="../../_/js/site.js"></script>
<script async src="../../_/js/vendor/fontawesome-icon-defs.js"></script>
<script async src="../../_/js/vendor/fontawesome.js"></script>
<script async src="../../_/js/vendor/highlight.js"></script>

<script async id="search-script" src="../../_/js/vendor/docsearch.js" data-app-id="FIPLENFG5M" data-api-key="489d96aa4ae574ec7ad1f23741a2d46d" data-index-name="cemosis" data-stylesheet="../../_/css/vendor/docsearch.css">
</script>

  </body>
</html>
