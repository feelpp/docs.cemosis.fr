<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Implementation :: Cemosis Docs</title>
    <link rel="canonical" href="https://docs.cemosis.fr/mqs/latest/stage/implementation.html">
    <meta name="generator" content="Antora 2.3.3">
    <link rel="stylesheet" href="../../../_/css/site.css">
<link rel="icon" href="../../../_/img/favicon.ico" type="image/x-icon">    
<script>!function(l,p){if(l.protocol!==p&&l.host=="docs.antora.org"){l.protocol=p}else if(/\.gitlab\.io$/.test(l.host)){l.replace(p+"//docs.antora.org"+l.pathname.substr(l.pathname.indexOf("/",1))+l.search+l.hash)}}(location,"https:")</script>






<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  messageStyle: "none",
  tex2jax: {
    inlineMath: [['$','$'], ['\\(','\\)']],
    displayMath: [['$$','$$'], ['\\[','\\]']],
    processEscapes: true,
    processEnvironments: true, 
    ignoreClass: "nostem|nolatexmath"
  },
  asciimath2jax: {
    delimiters: [["\\$", "\\$"]],
    ignoreClass: "nostem|noasciimath"
  },

  TeX: {
      Macros: {
      RR: "{\\mathbb R}",
      NN: "{\\mathbb N}",
      Nso: "{N_{\\mathrm{so}}}",
      Nma: "{N_{\\mathrm{ma}}}",
      Nno: "{N_{\\mathrm{no}}}",
      Ne: "{N_{\\mathrm{e}}}",
      Ilag: ["{\\mathcal{I}^{\\mathrm{lag}}_{#1}}",1],
      calTh: "{\\mathcal{T}_h}",
      Ck: ["{\\mathcal{C}^{#1}}",1],
      Pk: ["{\\mathcal{P}^{#1}}",1],
      Qk: ["{\\mathcal{Q}^{#1}}",1],
      Pch: ["{P^{#1}_{c,h}}",1],
      Pcho: ["{P^{#1}_{c,h,0}}",1],
      Qch: ["{Q^{#1}_{c,h}}",1],
      Ich: ["{\\mathcal{I}^{#1}_{c,h}#2}",2],
      poly: ["{\\mathbb{#1}}",1],
      nf: "{n_f}",
      ngeo: "{n_{\\mathrm{geo}}}",
      geo: "{\\mathrm{geo}}",
      card: ["{\\operatorname{card}(#1)}",1],
      dim: ["{\\operatorname{dim}(#1)}",1],
      opdim: "{\\operatorname{dim}}",
      card: ["{\\operatorname{card}(#1)}",1],
      poly: ["{\\mathbb{#1}",1],
      R: ["{\\mathbb{R}^{#1}}",1],
      set: ["{\\left\\{#1\\right\\}}",1],
      diam: "{\\operatorname{diam}}",
      jump: ["{[\\![ #1 ]\\!]}",1],
      Next: "{\\mathrm{n}}",
      essinf: "{\\operatorname{ess}\\, \\operatorname{inf}}",
      tr: "{\\operatorname{tr}}",
      Id: "{\\mathcal{I}}",
      disp: ["{\\mathbf{#1}}",1],
      stresst: ["{\\mathbf{\\sigma(#1)}}",1],
      deformt: ["{\\mathbf{\\varepsilon(#1)}}",1],
      domain: "{\\Omega}",
      prect: ["{\\left\\(#1\\right\\)}",1],
      ds: "",
      bold: ["{\\bf #1}",1],
      p: "{\\mathrm{p}}",
      q:"{\\mathbf{q}}",
      n:"{\\mathbf{n}}",
      T:"{\\mathcal{T}}",
      F:"{\\mathcal{F}}",
      P:"{\\mathcal{P}}",
      v:"{\\mathbf{v}}"
  },
  extensions: ["mhchem.js"] }
});
</script>
<!--<script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.3/MathJax.js?config=TeX-MML-AM_CHTML"></script>-->
<!-- <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML' async></script> -->
<script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS_CHTML'>
</script>
<!--<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.6.0/MathJax.js?config=TeX-MML-AM_HTMLorMML"></script>-->

<!--<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.9.0/katex.min.css" integrity="sha384-TEMocfGvRuD1rIAacqrknm5BQZ7W7uWitoih+jMNFXQIbNl16bO8OZmylH/Vi/Ei" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.9.0/katex.min.js" integrity="sha384-jmxIlussZWB7qCuB+PgKG1uLjjxbVVIayPJwi6cG6Zb4YKq0JIw+OMnkkEC7kYCq" crossorigin="anonymous"></script>-->

    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-65761593-2"></script>
    <script>function gtag(){dataLayer.push(arguments)};window.dataLayer=window.dataLayer||[];gtag('js',new Date());gtag('config','UA-65761593-2')</script>
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar  navbar-expand-sm bg-dark navbar-dark">
    <div class="navbar-brand">
      <div class="navbar-item">
         <!--  <a href="https://book.feelpp.org">Feel++ documentation</a> -->
           <a href="https://docs.cemosis.fr">Cemosis Docs</a>
      </div>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://docs.cemosis.fr">Home</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <div class="navbar-link">Docs</div>
          <div class="navbar-dropdown">
            <div class="navbar-item"><strong>Latest Version</strong></div>

            <!-- this code allow to manage ordering of navbar item -->
               
              <a class="navbar-item" href="/cemosis/latest/index.html"> Cemosis Documentation </a>
                  
              <a class="navbar-item" href="/antora-ui-default/index.html"> Cemosis Documentation UI </a>
                  
              <a class="navbar-item" href="/eye2brain/current/index.html"> Eye2Brain Manual </a>
                  
              <a class="navbar-item" href="/feelpp-cfd/latest/index.html"> Feel++ CFD </a>
                  
              <a class="navbar-item" href="/mqs/latest/index.html"> Feel++ Maxwell Quasi Static </a>
                  
              <a class="navbar-item" href="/hemotumpp/0.1/index.html"> HemoTum++ </a>
                  
              <a class="navbar-item" href="/hifimagnet/stable/index.html"> HiFiMagnet Documentation </a>
                  
              <a class="navbar-item" href="/holo3/latest/index.html"> Holo3 </a>
                    
              <a class="navbar-item" href="/ibat/latest/index.html"> IBat Docs </a>
                  
              <a class="navbar-item" href="/msqab/0.1/index.html"> msqab </a>
                  
              <a class="navbar-item" href="/swimmer/latest/index.html"> Swimmer Docs </a>
               

            <hr class="navbar-divider">
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <div class="navbar-link">Feel++</div>
          <div class="navbar-dropdown">
            <div class="navbar-item"><strong>GitHub</strong></div>
            <a class="navbar-item" href="http://github.com/feelpp/feelpp">GitHub Repository</a>
            <a class="navbar-item" href="http://github.com/feelpp/feelpp/issues">GitHub Issue Tracker</a>
            <hr class="navbar-divider">
            <div class="navbar-item"><strong>Documentation</strong></div>
            <a class="navbar-item" href="http://docs.feelpp.org/user/">User Manual</a>
            <a class="navbar-item" href="http://docs.feelpp.org/dev/">Developer Manual</a>
            <a class="navbar-item" href="http://docs.feelpp.org/toolbox/">Toolbox Manual</a>
            
          </div>
        </div>
        <div class="primary-action">
            <form class="navbar-item search">
              <input type="text" placeholder="Search Cemosis Docs" class="query" id="search-query">
              <button type="button" class="search-btn"><i class="fas fa-search"></i></button>
            </form>
        </div>
        <div class="navbar-item">
          <a class="navbar-brand" href="https://join.slack.com/t/feelpp/shared_invite/zt-2qe0q9hw-4pVbhohCXUE6Po9Ma8dbiQ">
            <img src="../../../_/img/slack.png" alt="slack" style="width:30px;"></a>
        </div>
        <div class="navbar-item">
          <a class="navbar-brand"  href="http://docs.feelpp.org">
            <img src="../../../_/img/logoFeelpp.png" alt="Feel++" style="width:60px;">
          </a>
        </div>
        <div class="navbar-item">
          <a class="navbar-brand"  href="http://www.cemosis.fr">
            <img src="../../../_/img/logoCemosisTransparent.png" alt="Cemosis" style="width:60px;">
          </a>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="mqs" data-version="latest">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../index.html">Feel++ Maxwell Quasi Static</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">MQS</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Outline of the project</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../front.html">Modeling the transient behavior of high field magnets</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../index.html">Introduction</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../formulation.html">Formulation</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../discretization.html">Discretization</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../implementation.html">Implementation</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../validation.html">Validations</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../conclusion.html">Conclusion</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../acknowledgments.html">Acknowledgments</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../code.html">Code</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../bibliography.html">Bibliography</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../appendix.html">Appendix</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Roadmap</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../roadmap.html">Roadmap</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">References</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#toolboxes:maxwell:mqs/README.adoc">Eddy Currents</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">MQS stage</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Outline of the project</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="front.html">Modeling the transient behavior of high field magnets</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="index.html">Introduction</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="formulation.html">Maxwell&#8217;s equations and MQS approximation</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="validation.html">Validations</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="endimple.html">End of the project, beginning and objective of the stage</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="results.html">Implementation of MQS equations and results</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="bdf.html">Backward differentiation formula</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="mqsheat.html">Add the heat equation</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="resolution1.html">Linear resolution</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="resolution2.html">Non-linear resolution</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="appendix.html">Appendix</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Feel++ Maxwell Quasi Static</span>
    <span class="version">latest</span>
  </div>
  <ul class="components">
    <li class="component">
      <span class="title">Cemosis Documentation</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../cemosis/latest/index.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">Cemosis Documentation UI</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../antora-ui-default/index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">Eye2Brain Manual</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../eye2brain/current/index.html">current</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">Feel++ CFD</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../feelpp-cfd/latest/index.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component is-current">
      <span class="title">Feel++ Maxwell Quasi Static</span>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../index.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">HemoTum++</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../hemotumpp/0.1/index.html">0.1</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">HiFiMagnet Documentation</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../hifimagnet/stable/index.html">stable</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">Holo3</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../holo3/latest/index.html">latest</a>
        </li>
        <li class="version">
          <a href="../../../holo3/doc-pierre/index.html">doc-pierre</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">IBat Docs</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../ibat/latest/index.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">msqab</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../msqab/0.1/index.html">0.1</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">Swimmer Docs</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../swimmer/latest/index.html">latest</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../../../cemosis/latest/index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../index.html">Feel++ Maxwell Quasi Static</a></li>
    <li><a href="implementation.html">Implementation</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/feelpp/mqs/edit/master/docs/modules/stage/pages/implementation.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<h1 class="page">Implementation</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>To implement the two discretized equations obtained in the discretization paragraph, we will first program the resolution of the first equation and then of the second one. Finally, we will implement the two equations together, and solve the system.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_first_equation"><a class="anchor" href="#_first_equation"></a>1. First equation</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Remember that for the first equation we have :</p>
</div>
<div class="stemblock">
<div class="content">
\[\begin{equation}
\int_{\Omega} \frac{\Delta t}{\mu} \, (\nabla \times \phi) \cdot (\nabla \times A^n) - \int_{\Gamma_D} \frac{1}{\mu} A_D \cdot (\nabla \times A^n) + \int_{\Omega_C} \sigma \phi \cdot (A^n + \Delta t \nabla V) =  \int_{\Omega_C} \sigma \phi \cdot A^{n-1}
\end{equation}\]
</div>
</div>
<div class="paragraph">
<p>To solve the first equation only, we will assume that V is known.
By slightly transforming the first equation, we obtain :</p>
</div>
<div class="stemblock">
<div class="content">
\[\begin{equation}
\int_{\Omega} \frac{\Delta t}{\mu} \, (\nabla \times \phi) \cdot (\nabla \times A^n) - \int_{\Gamma_D} \frac{1}{\mu} A_D \cdot (\nabla \times A^n) + \int_{\Omega_C} \sigma \phi \cdot A^n =  \int_{\Omega_C} \sigma \phi \cdot (A^{n-1} - \Delta t \nabla V)
\end{equation}\]
</div>
</div>
<div class="paragraph">
<p>We will now implement this equation under feelpp.
First, we define the \(\Omega\), the domain, as well as the \(\Omega_C\), the sub-domain of the conductor.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cpp hljs" data-lang="cpp">auto mesh = loadMesh(_mesh = new Mesh&lt;Simplex&lt;3&gt;&gt;);
auto cond_mesh = createSubmesh(mesh, markedelements(mesh, "Omega_C"));</code></pre>
</div>
</div>
<div class="paragraph">
<p>Remember that \(A \in H_{A_D}^{curl}\), but here, to simplify, we will consider that \(A \in H^{1}\), so we have to take a correct function space for \(A^n\) :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cpp hljs" data-lang="cpp">auto Ah = Pchv&lt;1&gt;(mesh);</code></pre>
</div>
</div>
<div class="paragraph">
<p>We now define all of our elements :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cpp hljs" data-lang="cpp">auto A = Ah-&gt;element(A0);
auto phi = Ah-&gt;element();
auto Aexact = Ah-&gt;element();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Where \(Aexact\) is the exact solution of a given problem, and where A is initialized with \(A0\).</p>
</div>
<div class="paragraph">
<p>Then we create the first and second member of the weak formulation, the exporter and the time variable.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cpp hljs" data-lang="cpp">auto l1 = form1(_test = Ah);
auto a1 = form2(_trial = Ah, _test = Ah);
double t = 0;
auto e = exporter(_mesh = mesh);</code></pre>
</div>
</div>
<div class="paragraph">
<p>We define result at time 0, the \(H^1\) and \(L^2\) errors.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cpp hljs" data-lang="cpp">Vexact_g.setParameterValues({{"t", t}});
Vexact = project(_space = Vh, _expr = Vexact_g);

gradV.setParameterValues({{"t", t}});
e-&gt;step(t)-&gt;add("V", V0);
e-&gt;step(t)-&gt;add("Vexact", Vexact);
e-&gt;save();

double L2Vexact = normL2(_range = elements(mesh), _expr = Vexact_g);
double H1error = 0;
double L2error = 0;</code></pre>
</div>
</div>
<div class="paragraph">
<p>We then begin the time loop, were we write the first and second member at time t :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cpp hljs" data-lang="cpp">Aexact_g.setParameterValues({{"t", t}});
Aexact = project(_space = Ah, _expr = Aexact_g);
gradV.setParameterValues({{"t", t}});
gO.setParameterValues({{"t", t}});
gI.setParameterValues({{"t", t}});
Ad.setParameterValues({{"t", t}});

l1.zero();
a1.zero();
l1 = integrate(_range = elements(cond_mesh),
                _expr = sigma * inner(id(phi), idv(A) - dt * gradV));
a1 = integrate(_range = elements(mesh),
                _expr = (dt / mu) * inner(curl(phi), curlt(A)));
a1 += integrate(_range = elements(cond_mesh),
                _expr = sigma * inner(id(phi), idt(A)));
a1 += on(_range = markedfaces(mesh, "Gamma_I"), _rhs = l1, _element = phi,
         _expr = gI);
a1 += on(_range = markedfaces(mesh, "Gamma_O"), _rhs = l1, _element = phi,
         _expr = gO);
a1 += on(_range = markedfaces(mesh, "Gamma_C"), _rhs = l1, _element = phi,
         _expr = Ad);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally, we finish by solving the equation at time t, exporting the result, and error calculations.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cpp hljs" data-lang="cpp">a1.solve(_rhs = l1, _solution = A);

e-&gt;step(t)-&gt;add("A", A);
e-&gt;step(t)-&gt;add("Aexact", Aexact_g);
e-&gt;save();

L2Aexact = normL2(_range = elements(mesh), _expr = Aexact_g);
L2error = normL2(elements(mesh), (idv(A) - idv(Aexact)));
H1error = normH1(elements(mesh), _expr = (idv(A) - idv(Aexact)), _grad_expr = (gradv(A) - gradv(Aexact)));</code></pre>
</div>
</div>
<div class="paragraph">
<p>And we start the loop again, which end when \(t \geq tmax\).</p>
</div>
<div class="paragraph">
<p>Complete code is available in the code section.</p>
</div>
<div class="paragraph">
<p>Now, we will test this program using the function \(V = (-xz,0,-\frac{t}{\sigma})\) with \(\sigma = 58000\) and \(\mu = 1\).
Note that the exact solution \(A\) for this \(V\) is \(A = (xzt,0,0)\).</p>
</div>
<div class="paragraph">
<p>We will also take the time \(t \in [0,1]\), with a step time \(dt=0.025\).</p>
</div>
<div class="paragraph">
<p>We&#8217;ll run the simulation on a bar, representing the conductor.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="_images/test1/geo.png" alt="geometry" width="50%"></span></p>
</div>
<div class="paragraph">
<p>This is the config file of the simulation :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cfg hljs" data-lang="cfg">directory=hifimagnet/mqs/test1

[gmsh]
hsize=0.1
filename=$cfgdir/test1.geo

[functions]
a={0,0,0}
i={x*z*t,0,0}:x:y:z:t
o={x*z*t,0,0}:x:y:z:t
d={x*z*t,0,0}:x:y:z:t
v={-x*z,0,-t/58000}:x:y:z:t
m=1
s=58000
e={x*z*t,0,0}:x:y:z:t

[ts]
time-step = 0.025
time-final = 1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Below are the errors we get at different times, with the associated graph in log scale.</p>
</div>
<div class="paragraph">
<p>\(t=0.1\):</p>
</div>
<table class="tableblock frame-all grid-all" style="width: 75%;">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">h</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">O.05</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">\(L^2\) error</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.000198386</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5.29439e-05</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1.40537e-05</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">\(L^2\) relative error</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.000532326</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.000142063</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3.77101e-05</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">\(H^1\) error</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.00318232</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.00178333</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.000950294</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><span class="image"><img src="_images/test1/p01.png" alt="geometry" width="50%"></span></p>
</div>
<div class="paragraph">
<p>\(t=0.5\):</p>
</div>
<table class="tableblock frame-all grid-all" style="width: 75%;">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">h</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">O.05</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">\(L^2\) error</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.000992004</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.000264656</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">7.02804e-05</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">\(L^2\) relative error</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.000532365</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.000142029</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3.77164e-05</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">\(H^1\) error</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.0159153</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.00891686</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.00476399</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><span class="image"><img src="_images/test1/p05.png" alt="geometry" width="50%"></span></p>
</div>
<div class="paragraph">
<p>\(t=0.9\):</p>
</div>
<table class="tableblock frame-all grid-all" style="width: 75%;">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">h</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">O.05</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">\(L^2\) error</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.00178574</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.000476291</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.000126614</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">\(L^2\) relative error</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.000532405</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.000142003</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3.77491e-05</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">\(H^1\) error</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.0286545</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.0160523</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.00861033</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><span class="image"><img src="_images/test1/p09.png" alt="geometry" width="50%"></span></p>
</div>
<div class="paragraph">
<p>Here is a comparison under paraview between the exact solution and the calculated solution, at different time :</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="_images/test1/t01.png" alt="geometry" width="75%"></span></p>
</div>
<div class="paragraph">
<p><span class="image"><img src="_images/test1/t05.png" alt="geometry" width="75%"></span></p>
</div>
<div class="paragraph">
<p><span class="image"><img src="_images/test1/t09.png" alt="geometry" width="75%"></span></p>
</div>
<div class="paragraph">
<p>We conclude that at every time, the \(L^2\) error slope is close to 2, which is what we expect to have,
and the \(H^1\) error slope is also close to 1. The difference can be explain by the fact we took only 3 different hsize, and the result could be better with lower hsize (but the running time can become very long).</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_second_equation"><a class="anchor" href="#_second_equation"></a>2. Second equation</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Our second equation is :</p>
</div>
<div class="stemblock">
<div class="content">
\[\begin{equation}
 \int_{\Omega_C} \sigma (A^n + \Delta t\nabla V) \cdot \nabla \psi =  \int_{\Omega_C} \sigma A^{n-1} \cdot \nabla \psi
\end{equation}\]
</div>
</div>
<div class="paragraph">
<p>To solve the second equation only, we will assume that \(\frac{\partial A}{\partial t}\) is known.
By slightly transforming this equation, we obtain :</p>
</div>
<div class="stemblock">
<div class="content">
\[\begin{equation}
 \int_{\Omega_C} \sigma \nabla V \cdot \nabla \psi = - \int_{\Omega_C} \frac{\partial A}{\partial t} \cdot \nabla \psi
\end{equation}\]
</div>
</div>
<div class="paragraph">
<p>The code is almost the same as before, with a few modifications :</p>
</div>
<div class="paragraph">
<p>First, we change our function space :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cpp hljs" data-lang="cpp">auto Vh = Pch&lt;1&gt;( cond_mesh );</code></pre>
</div>
</div>
<div class="paragraph">
<p>and we define our elements :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cpp hljs" data-lang="cpp">auto V = Vh-&gt;element(V0);
auto psi = Vh-&gt;element();
auto Vexact = Vh-&gt;element();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then we define our two forms :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cpp hljs" data-lang="cpp">auto a2 = form2( _trial=Vh, _test=Vh);
auto l2 = form1( _test=Vh );
auto e = exporter( _mesh=mesh );</code></pre>
</div>
</div>
<div class="paragraph">
<p>The last change is inside the loop, were we define the second equation :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cpp hljs" data-lang="cpp">l2 = integrate(_range=elements(cond_mesh),_expr = sigma * inner( -dA, trans(grad(psi)) ));

a2 = integrate(_range=elements(cond_mesh),_expr = sigma * inner(gradt(V), grad(psi) ));

a2 += on(_range=markedfaces(cond_mesh,"Gamma_I"), _rhs=l2, _element=psi, _expr= gI );
a2 += on(_range=markedfaces(cond_mesh,"Gamma_O"), _rhs=l2, _element=psi, _expr= gO );
a2 += on(_range=markedfaces(cond_mesh,"Gamma_C"), _rhs=l2, _element=psi, _expr= Ad );</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then we solve, and we compute the errors.</p>
</div>
<div class="paragraph">
<p>Complete code is available in the code section.</p>
</div>
<div class="paragraph">
<p>Now we will test this program with two different set of function :
First will be with the function \(A = (-t,0,0)\), so \(\frac{\partial A}{\partial t} = (-1,0,0)\).
Note that the exact solution is \(V = zt\).</p>
</div>
<div class="paragraph">
<p>We will run the simulation on the same geometry as before, with same time and step time.</p>
</div>
<div class="paragraph">
<p>This are the errors we get with hsize = 0.1 :</p>
</div>
<table class="tableblock frame-all grid-all" style="width: 75%;">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">t</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">O.9</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">\(L^2\) error</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1.40624e-15</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3.01653e-15</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">7.75481e-15</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">\(L^2\) relative error</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2.17853e-15</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">9.34637e-16</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1.33486e-15</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">\(H^1\) error</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4.47471e-15</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2.05823e-14</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3.85823e-14</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The error is 0 at epsilon machine, which is what is expected because the function is linear in space.</p>
</div>
<div class="paragraph">
<p>This is the config file for this simulation :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cfg hljs" data-lang="cfg">directory=hifimagnet/mqs/test2

[gmsh]
hsize=0.1
filename=$cfgdir/test2.geo

[functions]
v=0
a={-t,0,0}:x:y:z:t
i=z*t:x:y:z:t
o=z*t:x:y:z:t
d=z*t:x:y:z:t
s=58000
e=z*t:x:y:z:t

[ts]
time-step = 0.025
time-final = 1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we will use the function \(A = (-xt,0,zt)\), so \(\frac{\partial A}{\partial t} = (-x,0,z)\).
Note that the exact solution is \(V = zxt\).</p>
</div>
<div class="paragraph">
<p>We will run the simulation on the same geometry as before, with same time and step time.</p>
</div>
<div class="paragraph">
<p>Below are the errors we get at different times, with the associated graph in log scale.</p>
</div>
<div class="paragraph">
<p>\(t=0.1\):</p>
</div>
<table class="tableblock frame-all grid-all" style="width: 75%;">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">h</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">O.05</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">\(L^2\) error</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.000318572</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">8.66208e-05</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2.23948e-05</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">\(L^2\) relative error</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.00085482</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.000232428</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">6.00916e-05</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">\(H^1\) error</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.00537588</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.00303521</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.00161933</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><span class="image"><img src="_images/test2/p01.png" alt="geometry" width="50%"></span></p>
</div>
<div class="paragraph">
<p>\(t=0.5\):</p>
</div>
<table class="tableblock frame-all grid-all" style="width: 75%;">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">h</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">O.05</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">\(L^2\) error</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.00159286</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.000433104</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.000111974</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">\(L^2\) relative error</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.00085482</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.000232428</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">6.00916e-05</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">\(H^1\) error</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.0268794</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.0151761</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.00809665</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><span class="image"><img src="_images/test2/p05.png" alt="geometry" width="50%"></span></p>
</div>
<div class="paragraph">
<p>\(t=0.9\)</p>
</div>
<table class="tableblock frame-all grid-all" style="width: 75%;">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">h</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">O.05</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">\(L^2\) error</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.00286715</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.000779587</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.000201553</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">\(L^2\) relative error</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.00085482</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.000232428</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">6.00916e-05</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">\(H^1\) error</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.0483829</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.0273169</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.014574</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><span class="image"><img src="_images/test2/p09.png" alt="geometry" width="50%"></span></p>
</div>
<div class="paragraph">
<p>Here is a comparison under paraview between the exact solution and the calculated solution, at different time:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="_images/test1/t01.png" alt="geometry" width="75%"></span></p>
</div>
<div class="paragraph">
<p><span class="image"><img src="_images/test1/t05.png" alt="geometry" width="75%"></span></p>
</div>
<div class="paragraph">
<p><span class="image"><img src="_images/test1/t09.png" alt="geometry" width="75%"></span></p>
</div>
<div class="paragraph">
<p>This is the config file of the simulation :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cfg hljs" data-lang="cfg">directory=hifimagnet/mqs/test22

[gmsh]
hsize=0.1
filename=$cfgdir/test2.geo

[functions]
v=0
a={-x*t,0,z*t}:x:y:z:t
i=x*z*t:x:y:z:t
o=x*z*t:x:y:z:t
d=x*z*t:x:y:z:t
s=58000
e=x*z*t:x:y:z:t

[ts]
time-step = 0.025
time-final = 1</code></pre>
</div>
</div>
<div class="paragraph">
<p>We can conclude that the \(L^2\) and \(H^1\) errors are what expected, for the same reason as first equation.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_coupled_system"><a class="anchor" href="#_coupled_system"></a>3. Coupled system</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now we take back our system :</p>
</div>
<div class="stemblock">
<div class="content">
\[\begin{equation}
\int_{\Omega} \frac{\Delta t}{\mu} \, (\nabla \times \phi) \cdot (\nabla \times A^n) - \int_{\Gamma_D} \frac{1}{\mu} A_D \cdot (\nabla \times A^n) + \int_{\Omega_C} \sigma \phi \cdot (A^n + \Delta t \nabla V) =  \int_{\Omega_C} \sigma \phi \cdot A^{n-1}
\end{equation}\]
</div>
</div>
<div class="stemblock">
<div class="content">
\[\begin{equation}
\int_{\Omega_C} \sigma (A^n + \Delta t\nabla V) \cdot \nabla \psi =  \int_{\Omega_C} \sigma A^{n-1} \cdot \nabla \psi
\end{equation}\]
</div>
</div>
<div class="paragraph">
<p>Which can be rewrite :</p>
</div>
<div class="stemblock">
<div class="content">
\[\begin{equation}
\int_{\Omega} \frac{\Delta t}{\mu} \, (\nabla \times \phi) \cdot (\nabla \times A^n) + \int_{\Omega_C} \sigma \phi \cdot A^n - \int_{\Gamma_D} \frac{1}{\mu} A_D \cdot (\nabla \times A^n) + \int_{\Omega_C} \sigma \phi \cdot \Delta t \nabla V =  \int_{\Omega_C} \sigma \phi \cdot A^{n-1}
\end{equation}\]
</div>
</div>
<div class="stemblock">
<div class="content">
\[\begin{equation}
 \int_{\Omega_C} \sigma A^n \cdot \nabla \psi +  \int_{\Omega_C} \sigma \Delta t\nabla V \cdot \nabla \psi =  \int_{\Omega_C} \sigma A^{n-1} \cdot \nabla \psi
\end{equation}\]
</div>
</div>
<div class="paragraph">
<p>To implement it under feelpp, we have to use blockform and product space, because \((A,V) \in H^1(\Omega) \times H^1(\Omega_C)\).</p>
</div>
<div class="paragraph">
<p>So first, after we define the mesh as same way as before, we create our elements :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cpp hljs" data-lang="cpp">auto Ah = Pchv&lt;1&gt;( mesh );
auto Vh = Pch&lt;1&gt;( cond_mesh );

auto A = Ah-&gt;element(A0);
auto V = Vh-&gt;element(V0);

auto Aexact = Ah-&gt;element();
auto Vexact = Vh-&gt;element();

auto phi = Ah-&gt;element();
auto psi = Vh-&gt;element();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then we define the produt space, and create our element on this product space :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cpp hljs" data-lang="cpp">auto Zh = product(Ah,Vh);
auto U = Zh.element();</code></pre>
</div>
</div>
<div class="paragraph">
<p>We have to create the blockforms for the right and left side of our system :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cpp hljs" data-lang="cpp">auto rhs = blockform1( Zh );
auto lhs = blockform2( Zh );</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then we create the exporter, and export the solution for A and V at time \(t=0\).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cpp hljs" data-lang="cpp">double t = 0;

auto e = exporter( _mesh=mesh );

Aexact_g.setParameterValues({{"t", t}});
Aexact = project(_space = Ah, _expr = Aexact_g);

Vexact_g.setParameterValues({{"t", t}});
Vexact = project(_space = Vh, _expr = Vexact_g);

e-&gt;step(t)-&gt;add("A", A0);
e-&gt;step(t)-&gt;add("Aexact", Aexact);
e-&gt;step(t)-&gt;add("V", V0);
e-&gt;step(t)-&gt;add("Vexact", Vexact);
e-&gt;save();

double L2Aexact = normL2(_range = elements(mesh), _expr = Aexact_g);
double H1Aerror = 0;
double L2Aerror = 0;
double L2Vexact = normL2(_range = elements(mesh), _expr = Vexact_g);
double H1Verror = 0;
double L2Verror = 0;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we begin the temporal loop, so we have to set our variables at the correct time :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cpp hljs" data-lang="cpp">Aexact_g.setParameterValues({{"t", t}});
Aexact = project(_space = Ah, _expr = Aexact_g);
Vexact_g.setParameterValues({{"t", t}});
Vexact = project(_space = Vh, _expr = Vexact_g);
v0.setParameterValues({{"t", t}});
v1.setParameterValues({{"t", t}});
Ad.setParameterValues({{"t", t}});</code></pre>
</div>
</div>
<div class="paragraph">
<p>And we can write both equation inside the blockforms:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cpp hljs" data-lang="cpp">lhs.zero();
rhs.zero();
// Ampere law: sigma dA/dt + rot(1/(mu-r*mu_0) rotA) + sigma grad(V) = Js
lhs(0_c, 0_c) = integrate( _range=elements(mesh),_expr = dt * inner(curl(phi) , curlt(A)) );
lhs(0_c, 0_c) += integrate( _range=elements(cond_mesh),_expr = mur * mu0 * sigma * inner(id(phi) , idt(A) ));
lhs(0_c, 1_c) = integrate(_range=elements(cond_mesh),_expr = dt * mu0 * mur * sigma*inner(id(phi),trans(gradt(V))) );
rhs(0_c) = integrate(_range=elements(cond_mesh),_expr = mu0 * mur * sigma * inner(id(phi) , idv(A)));

// Current conservation: div( -sigma grad(V) -sigma*dA/dt) = Qs
lhs(1_c, 0_c) = integrate( _range=elements(cond_mesh),_expr = sigma * inner(idt(A), trans(grad(psi))) );
lhs(1_c, 1_c) = integrate( _range=elements(cond_mesh),_expr = sigma * dt * inner(gradt(V), grad(psi)) );
rhs(1_c) = integrate(_range=elements(cond_mesh),_expr = sigma * inner(idv(A), trans(grad(psi))) );</code></pre>
</div>
</div>
<div class="paragraph">
<p>The last step before solving is to set the boundary counditions. This is how we did it :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cpp hljs" data-lang="cpp">lhs(0_c, 0_c) += on(_range=markedfaces(mesh,"V0"), _rhs=rhs(0_c), _element=phi, _expr= Ad);
lhs(0_c, 0_c) += on(_range=markedfaces(mesh,"V1"), _rhs=rhs(0_c), _element=phi, _expr= Ad);
lhs(0_c, 0_c) += on(_range=markedfaces(mesh,"Gamma_C"), _rhs=rhs(0_c), _element=phi, _expr= Ad);

lhs(1_c, 1_c) += on(_range=markedfaces(cond_mesh,"V0"), _rhs=rhs(1_c), _element=psi, _expr= v0);
lhs(1_c, 1_c) += on(_range=markedfaces(cond_mesh,"V1"), _rhs=rhs(1_c), _element=psi, _expr= v1);
lhs(1_c, 1_c) += on(_range=markedfaces(cond_mesh,"Gamma_C"), _rhs=rhs(1_c), _element=psi, _expr= Vexact_g);</code></pre>
</div>
</div>
<div class="paragraph">
<p>And then, we solve and export :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cpp hljs" data-lang="cpp">lhs.solve(_rhs=rhs,_solution=U);

e-&gt;step(t)-&gt;add( "A", U(0_c));
e-&gt;step(t)-&gt;add( "V", U(1_c));
e-&gt;step(t)-&gt;add( "Aexact", Aexact);
e-&gt;step(t)-&gt;add( "Vexact", Vexact);
e-&gt;save();</code></pre>
</div>
</div>
<div class="paragraph">
<p>But, this is probably not the good way to do it.
Reason is, when we solve (and export) the system we dont have good results. For exemple, at the time \(t=dt\), the solution we obtain is not close to the exact one, and the error bad.
The visualization tends to prove that our boundary counditions are not set properly. The boundary should be the same as the exact solution,
because we define boundary with the exact solution, but they are differents.
So the way we set boundary condition in the code seems to be not correct.</p>
</div>
<div class="paragraph">
<p>The consequence is that we haven&#8217;t been able to visualize correct results for a resolution yet.</p>
</div>
<div class="paragraph">
<p>Complete code is available in the code section.</p>
</div>
<div class="paragraph">
<p>Config file use for simulation :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cfg hljs" data-lang="cfg">directory=hifimagnet/mqs/mqs-blockform/conductor/const
A0={0,0,0}:x:y:z
V0=z:x:y:z
v0=z:x:y:z:t
v1=z:x:y:z:t
Ad={0,0,-t}:x:y:z:t
mu_mag=1
sigma=1
Aexact={0,0,-t}:x:y:z:t
Vexact=z:x:y:z:t

[gmsh]
hsize=0.1
filename=$cfgdir/conductor.geo

[ts]
time-step=0.025
time-final=1</code></pre>
</div>
</div>
</div>
</div>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>

  </div>
</main>
</div>
<footer class="footer">
  <div class="container">
    <div class="footer-links">
      <div class="col">
        <div class="footer-logo">
          <a href="https://www.cemosis.fr" class="icon">
            <img src="../../../_/img/logoCemosisTransparent.png" alt="Cemosis">
          </a>
        </div>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://docs.cemosis.fr" target="_blank" rel="noopener">Projects Documentation</a></li>
          <li><a href="https://join.slack.com/t/feelpp/shared_invite/zt-2qe0q9hw-4pVbhohCXUE6Po9Ma8dbiQ" target="_blank" rel="noopener">Forums(Slack)</a></li>
        </ul>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://www.cemosis.fr" target="_blank" rel="noopener">Cemosis</a></li>
          <li><a href="https://www.cemosis.fr/news" target="_blank" rel="noopener">News</a></li>
          <li><a href="https://www.cemosis.fr/projects" target="_blank" rel="noopener">Projects</a></li>
        </ul>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://docs.feelpp.org" target="_blank" rel="noopener">Feel++ Documentation</a></li>
          <li><a href="http://docs.feelpp.org/user/">Get Started</a></li>
          <li><a href="http://docs.feelpp.org/user//install/distributions/">Downloads</a></li>
        </ul>
      </div>
      <div class="col">
        <ul class="social-icons">
          <li>
            <svg  width="14" height="14" viewBox="0 0 32 32"> <path id="facebook" class="cls-1" d="M29,0H3A2.652,2.652,0,0,0,0,3V29a2.652,2.652,0,0,0,3,3H16V18H12V14h4V12a6.452,6.452,0,0,1,6-6h4v4H22a2.151,2.151,0,0,0-2,2v2h6l-1,4H20V32h9a2.652,2.652,0,0,0,3-3V3A2.652,2.652,0,0,0,29,0Z"/></svg>
            <a href="https://www.facebook.com/cemosis.fr" class="icon">
            Facebook
            </a>
          </li>
          <li>
            <svg  width="14" height="14" viewBox="0 0 32.1 26.1"> <path id="twitter" class="cls-1" d="M32,7.1a11.836,11.836,0,0,1-3.8,1,6.462,6.462,0,0,0,2.9-3.6,12.606,12.606,0,0,1-4.2,1.6A6.492,6.492,0,0,0,22.1,4a6.594,6.594,0,0,0-6.6,6.6,7.719,7.719,0,0,0,.2,1.5A18.458,18.458,0,0,1,2.2,5.2a6.294,6.294,0,0,0-.9,3.3A6.765,6.765,0,0,0,4.2,14a6.109,6.109,0,0,1-3-.8v.1a6.543,6.543,0,0,0,5.3,6.4,4.678,4.678,0,0,1-1.7.2,4.869,4.869,0,0,1-1.2-.1,6.679,6.679,0,0,0,6.1,4.6,12.917,12.917,0,0,1-8.2,2.8,9.151,9.151,0,0,1-1.6-.1,18.438,18.438,0,0,0,10.1,3c12.1,0,18.7-10,18.7-18.7v-.8A13.336,13.336,0,0,0,32,7.2Z" transform="translate(0.1 -4)"/></svg>
            <a href="https://twitter.com/cemosis" class="icon">
              Twitter
            </a>
          </li>
          <li>
          <svg  width="14" height="14" viewBox="0 0 32 32"> <path id="linkedin" class="cls-1" d="M29,0H3A3.076,3.076,0,0,0,0,3V29a3.009,3.009,0,0,0,3,3H29a2.946,2.946,0,0,0,3-3V3A3.009,3.009,0,0,0,29,0ZM12,26H8V12h4ZM10,10a2,2,0,1,1,2-2A2.006,2.006,0,0,1,10,10ZM26,26H22V18a2,2,0,0,0-4,0v8H14V12h4v2.5c.8-1.1,2.1-2.5,3.5-2.5A4.736,4.736,0,0,1,26,17Z"/></svg>
              <a href="https://www.linkedin.com/company/cemosis" class="icon">
             Linkedin
            </a>
          </li>
        </ul>
      </div>
    </div>
    <div class="footer-terms">
      <div class="footer-terms-copyright">
          <span>© 2020 Cemosis, Université de Strasbourg</span>
      </div>
      <div class="footer-terms-links">
        <a href="https://www.cemosis.fr/terms-of-use">Terms of Use</a>
        <a href="https://www.cemosis.fr/privacy-policy">Privacy Policy</a>
        <a href="https://www.cemosis.fr/cookie-policy">Cookie Policy</a>
        <a href="https://www.cemosis.fr/support-policy">Support Policy</a>
      </div>
    </div>
  </div>
</footer>
<script src="../../../_/js/site.js"></script>
<script async src="../../../_/js/vendor/fontawesome-icon-defs.js"></script>
<script async src="../../../_/js/vendor/fontawesome.js"></script>
<script async src="../../../_/js/vendor/highlight.js"></script>

<script async id="search-script" src="../../../_/js/vendor/docsearch.js" data-app-id="FIPLENFG5M" data-api-key="489d96aa4ae574ec7ad1f23741a2d46d" data-index-name="cemosis" data-stylesheet="../../../_/css/vendor/docsearch.css">
</script>

  </body>
</html>
