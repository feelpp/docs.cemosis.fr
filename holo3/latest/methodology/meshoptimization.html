<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Mesh Optimisation :: Cemosis Docs</title>
    <link rel="canonical" href="https://docs.cemosis.fr/holo3/latest/methodology/meshoptimization.html">
    <meta name="generator" content="Antora 2.3.3">
    <link rel="stylesheet" href="../../../_/css/site.css">
<link rel="icon" href="../../../_/img/favicon.ico" type="image/x-icon">    
<script>!function(l,p){if(l.protocol!==p&&l.host=="docs.antora.org"){l.protocol=p}else if(/\.gitlab\.io$/.test(l.host)){l.replace(p+"//docs.antora.org"+l.pathname.substr(l.pathname.indexOf("/",1))+l.search+l.hash)}}(location,"https:")</script>






<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  messageStyle: "none",
  tex2jax: {
    inlineMath: [['$','$'], ['\\(','\\)']],
    displayMath: [['$$','$$'], ['\\[','\\]']],
    processEscapes: true,
    processEnvironments: true, 
    ignoreClass: "nostem|nolatexmath"
  },
  asciimath2jax: {
    delimiters: [["\\$", "\\$"]],
    ignoreClass: "nostem|noasciimath"
  },

  TeX: {
      Macros: {
      RR: "{\\mathbb R}",
      NN: "{\\mathbb N}",
      Nso: "{N_{\\mathrm{so}}}",
      Nma: "{N_{\\mathrm{ma}}}",
      Nno: "{N_{\\mathrm{no}}}",
      Ne: "{N_{\\mathrm{e}}}",
      Ilag: ["{\\mathcal{I}^{\\mathrm{lag}}_{#1}}",1],
      calTh: "{\\mathcal{T}_h}",
      Ck: ["{\\mathcal{C}^{#1}}",1],
      Pk: ["{\\mathcal{P}^{#1}}",1],
      Qk: ["{\\mathcal{Q}^{#1}}",1],
      Pch: ["{P^{#1}_{c,h}}",1],
      Pcho: ["{P^{#1}_{c,h,0}}",1],
      Qch: ["{Q^{#1}_{c,h}}",1],
      Ich: ["{\\mathcal{I}^{#1}_{c,h}#2}",2],
      poly: ["{\\mathbb{#1}}",1],
      nf: "{n_f}",
      ngeo: "{n_{\\mathrm{geo}}}",
      geo: "{\\mathrm{geo}}",
      card: ["{\\operatorname{card}(#1)}",1],
      dim: ["{\\operatorname{dim}(#1)}",1],
      opdim: "{\\operatorname{dim}}",
      card: ["{\\operatorname{card}(#1)}",1],
      poly: ["{\\mathbb{#1}",1],
      R: ["{\\mathbb{R}^{#1}}",1],
      set: ["{\\left\\{#1\\right\\}}",1],
      diam: "{\\operatorname{diam}}",
      jump: ["{[\\![ #1 ]\\!]}",1],
      Next: "{\\mathrm{n}}",
      essinf: "{\\operatorname{ess}\\, \\operatorname{inf}}",
      tr: "{\\operatorname{tr}}",
      Id: "{\\mathcal{I}}",
      disp: ["{\\mathbf{#1}}",1],
      stresst: ["{\\mathbf{\\sigma(#1)}}",1],
      deformt: ["{\\mathbf{\\varepsilon(#1)}}",1],
      domain: "{\\Omega}",
      prect: ["{\\left\\(#1\\right\\)}",1],
      ds: "",
      bold: ["{\\bf #1}",1],
      p: "{\\mathrm{p}}",
      q:"{\\mathbf{q}}",
      n:"{\\mathbf{n}}",
      T:"{\\mathcal{T}}",
      F:"{\\mathcal{F}}",
      P:"{\\mathcal{P}}",
      v:"{\\mathbf{v}}"
  },
  extensions: ["mhchem.js"] }
});
</script>
<!--<script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.3/MathJax.js?config=TeX-MML-AM_CHTML"></script>-->
<!-- <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML' async></script> -->
<script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS_CHTML'>
</script>
<!--<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.6.0/MathJax.js?config=TeX-MML-AM_HTMLorMML"></script>-->

<!--<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.9.0/katex.min.css" integrity="sha384-TEMocfGvRuD1rIAacqrknm5BQZ7W7uWitoih+jMNFXQIbNl16bO8OZmylH/Vi/Ei" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.9.0/katex.min.js" integrity="sha384-jmxIlussZWB7qCuB+PgKG1uLjjxbVVIayPJwi6cG6Zb4YKq0JIw+OMnkkEC7kYCq" crossorigin="anonymous"></script>-->

    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-65761593-2"></script>
    <script>function gtag(){dataLayer.push(arguments)};window.dataLayer=window.dataLayer||[];gtag('js',new Date());gtag('config','UA-65761593-2')</script>
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar  navbar-expand-sm bg-dark navbar-dark">
    <div class="navbar-brand">
      <div class="navbar-item">
         <!--  <a href="https://book.feelpp.org">Feel++ documentation</a> -->
           <a href="https://docs.cemosis.fr">Cemosis Docs</a>
      </div>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://docs.cemosis.fr">Home</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <div class="navbar-link">Docs</div>
          <div class="navbar-dropdown">
            <div class="navbar-item"><strong>Latest Version</strong></div>

            <!-- this code allow to manage ordering of navbar item -->
               
              <a class="navbar-item" href="/cemosis/latest/index.html"> Cemosis Documentation </a>
                  
              <a class="navbar-item" href="/antora-ui-default/index.html"> Cemosis Documentation UI </a>
                  
              <a class="navbar-item" href="/eye2brain/current/index.html"> Eye2Brain Manual </a>
                  
              <a class="navbar-item" href="/feelpp-cfd/latest/index.html"> Feel++ CFD </a>
                  
              <a class="navbar-item" href="/mqs/latest/index.html"> Feel++ Maxwell Quasi Static </a>
                  
              <a class="navbar-item" href="/hemotumpp/0.1/index.html"> HemoTum++ </a>
                  
              <a class="navbar-item" href="/hifimagnet/stable/index.html"> HiFiMagnet Documentation </a>
                  
              <a class="navbar-item" href="/holo3/latest/index.html"> Holo3 </a>
                    
              <a class="navbar-item" href="/ibat/latest/index.html"> IBat Docs </a>
                  
              <a class="navbar-item" href="/msqab/latest/index.html"> msqab </a>
                  
              <a class="navbar-item" href="/swimmer/latest/index.html"> Swimmer Docs </a>
               

            <hr class="navbar-divider">
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <div class="navbar-link">Feel++</div>
          <div class="navbar-dropdown">
            <div class="navbar-item"><strong>GitHub</strong></div>
            <a class="navbar-item" href="http://github.com/feelpp/feelpp">GitHub Repository</a>
            <a class="navbar-item" href="http://github.com/feelpp/feelpp/issues">GitHub Issue Tracker</a>
            <hr class="navbar-divider">
            <div class="navbar-item"><strong>Documentation</strong></div>
            <a class="navbar-item" href="http://docs.feelpp.org/user/">User Manual</a>
            <a class="navbar-item" href="http://docs.feelpp.org/dev/">Developer Manual</a>
            <a class="navbar-item" href="http://docs.feelpp.org/toolbox/">Toolbox Manual</a>
            
          </div>
        </div>
        <div class="primary-action">
            <form class="navbar-item search">
              <input type="text" placeholder="Search Cemosis Docs" class="query" id="search-query">
              <button type="button" class="search-btn"><i class="fas fa-search"></i></button>
            </form>
        </div>
        <div class="navbar-item">
          <a class="navbar-brand" href="https://join.slack.com/t/feelpp/shared_invite/zt-2qe0q9hw-4pVbhohCXUE6Po9Ma8dbiQ">
            <img src="../../../_/img/slack.png" alt="slack" style="width:30px;"></a>
        </div>
        <div class="navbar-item">
          <a class="navbar-brand"  href="http://docs.feelpp.org">
            <img src="../../../_/img/logoFeelpp.png" alt="Feel++" style="width:60px;">
          </a>
        </div>
        <div class="navbar-item">
          <a class="navbar-brand"  href="http://www.cemosis.fr">
            <img src="../../../_/img/logoCemosisTransparent.png" alt="Cemosis" style="width:60px;">
          </a>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="holo3" data-version="latest">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../index.html">Holo3</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../modeling/deflectometry.html">Introduction</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../polymap/polymap.html">Polymap</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="index.html">Methodology</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Domain Definition</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="uniformmesh.html">Uniform mesh</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="deformedmesh.html">Deformed mesh</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="meshpoly.html">Mesh extraction with polygons</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="meshls.html">Mesh extraction with levelset</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Reconstruction</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="problemformulation.html">Problem formulation</a>
  </li>
  <li class="nav-item is-current-page" data-depth="3">
    <a class="nav-link" href="meshoptimization.html">Mesh optimization</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="nonlinearproblem.html">Non linear problem</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="solver.html">Solver</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="serialcontrol.html">Serial control</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Data Selection</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../indicators/indicators.html">Indicators</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../indicators/low-contrast.html">Low Contrast</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../indicators/phase-spike.html">Phase Spike</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../indicators/phase-border.html">Phase Border</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../indicators/combine.html">Indicators combined</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#methodology/mesureetalon.adoc">Mesure Etalon</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../client-server/index.html">Client Server</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Numerical Experiments</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../experiments/serialbench.html">Serial Benchmark</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../experiments/standardbench.html">Standard Benchmark</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../experiments/testsuite.html">Testsuite</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../experiments/validation.html">Validation</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Report</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../report/report.html">Report 2020</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Holo3</span>
    <span class="version">latest</span>
  </div>
  <ul class="components">
    <li class="component">
      <span class="title">Cemosis Documentation</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../cemosis/latest/index.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">Cemosis Documentation UI</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../antora-ui-default/index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">Eye2Brain Manual</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../eye2brain/current/index.html">current</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">Feel++ CFD</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../feelpp-cfd/latest/index.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">Feel++ Maxwell Quasi Static</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../mqs/latest/index.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">HemoTum++</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../hemotumpp/0.1/index.html">0.1</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">HiFiMagnet Documentation</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../hifimagnet/stable/index.html">stable</a>
        </li>
      </ul>
    </li>
    <li class="component is-current">
      <span class="title">Holo3</span>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../index.html">latest</a>
        </li>
        <li class="version">
          <a href="../../doc-pierre/index.html">doc-pierre</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">IBat Docs</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../ibat/latest/index.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">msqab</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../msqab/latest/index.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">Swimmer Docs</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../swimmer/latest/index.html">latest</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../../../cemosis/latest/index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../index.html">Holo3</a></li>
    <li><a href="index.html">Methodology</a></li>
    <li>Reconstruction</li>
    <li><a href="meshoptimization.html">Mesh optimization</a></li>
  </ul>
</nav>
<div class="page-versions">
  <button class="version-menu-toggle" title="Show other versions of page">latest</button>
  <div class="version-menu">
    <a class="version is-current" href="meshoptimization.html">latest</a>
    <a class="version" href="../../doc-pierre/methodology/meshoptimization.html">doc-pierre</a>
  </div>
</div>
</div>
  <div class="content">
<article class="doc">
<h1 class="page">Mesh Optimisation</h1>
<div class="sect1">
<h2 id="_work_around_the_mesh"><a class="anchor" href="#_work_around_the_mesh"></a>1. Work around the Mesh</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Previously, we use the method <code>createGMSH</code> ( and so GMSH ) to build the mesh associated to our surface reconstrution problem. As shown ahead, it take a lot of time ( \(\simeq 70 s\)). Two possibilties will be explored here :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>First, a field, named update, of the <code>createGMSH</code> method can be used to determine how the mesh will be built.</p>
</li>
<li>
<p>After this, we want to generate manually our mesh, without <code>createGMSH</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>We will also add the condition on the heigth mean, for the moment equals to 0, in order to compare directly our results to the real surface data.</p>
</div>
<div class="sect2">
<h3 id="_mesh_enhancement"><a class="anchor" href="#_mesh_enhancement"></a>1.1. Mesh Enhancement</h3>
<div class="sect3">
<h4 id="_update_field"><a class="anchor" href="#_update_field"></a>1.1.1. Update field</h4>
<div class="paragraph">
<p>The update field on the <code>createGMSH</code> method allow us to determine what we want the mesh built and what we want it let behind. In our case, the only useful information is the adjacency between nodes and elements, in order to parallelize in the future the code. Things, like informations on elements face, aren&#8217;t needed here and can be shelve to gain time.</p>
</div>
<div class="paragraph">
<p>This field is used like this</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cpp hljs" data-lang="cpp">_uh = createGMSHMesh( _mesh=new Mesh&lt;Hypercube&lt;2&gt;&gt;,
                      _structured=1,
                      _h=doption(_name="pixelsize"),
                      _desc=domain(_name="polymere",
                                   _xmax=(x.cols()-1)*doption(_name="pixelsize"),
                                   _ymax=(x.rows()-1)*doption(_name="pixelsize")),
                      _update=size_type(MESH_UPDATE_ELEMENTS_ADJACENCY|MESH_NO_UPDATE_MEASURES));</code></pre>
</div>
</div>
<div class="paragraph">
<p>After recompilation and execution, we finally obtain the mesh built time</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">[Mesh built] Time : 41.2557s</code></pre>
</div>
</div>
<div class="paragraph">
<p>We have gain \(\simeq 30 s\) with this mesh beside the initial one.</p>
</div>
</div>
<div class="sect3">
<h4 id="_manually_mesh_built"><a class="anchor" href="#_manually_mesh_built"></a>1.1.2. Manually mesh built</h4>
<div class="paragraph">
<p>An another way to gain time on mesh built is to manually build it, without using GMSH. We can so direclty build the wanted informations whitout have to read it from a gmsh file. To manage this, we inspire us from methods used to read nodes and elements from GMSH to use these informations into Feel++.</p>
</div>
<div class="paragraph">
<p>It used like this in the main code :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cpp hljs" data-lang="cpp">auto mesh = boost::make_shared&lt;MeshStructured&gt;( x.rows()-1, x.cols()-1,
        doption(_name="pixelsize"),Environment::worldComm() );

mesh-&gt;components().reset();
mesh-&gt;components().set( size_type(MESH_NO_UPDATE_MEASURES) );
mesh-&gt;updateForUse();</code></pre>
</div>
</div>
<div class="sect4">
<h5 id="_nodes"><a class="anchor" href="#_nodes"></a>Nodes</h5>
<div class="paragraph">
<p>The main part of the nodes are define like this</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cpp hljs" data-lang="cpp">int start = (partId == 0) ? 0 : cx[partId]+1;
int stop = (partId == (procSize-1)) ? M_ny : cx[partId+1];
for( int j = start ; j &lt; stop; ++j )
{
    std::cout &lt;&lt; "j = " &lt;&lt; j &lt;&lt; std::endl;
    ghosts.clear();
    if (j == cx[partId] &amp;&amp; j != 0)
    ghosts.push_back(partId-1);
    else if (j == cx[partId+1]-1 &amp;&amp; j != M_ny-1)
    ghosts.push_back(partId+1);

    for( int i = 0; i &lt; M_nx; ++i )
 {
        // point
        int ptid = (M_ny)*i+j;
        //std::cout &lt;&lt; "ptId = " &lt;&lt; ptid &lt;&lt; std::endl;
        coords[0]=M_pixelsize*j;
        coords[1]=M_pixelsize*i;
        point_type pt( ptid,
                       coords,
                       i == 0 || i == M_nx-1
                       || j%((M_ny-1)/procSize) == 0 );

        //// Is on boundary ?
        pt.setMarker(1);
        //// Actual rank ID
        pt.setProcessId( partId );
        //// NO GHOST POINTS I SAID
        pt.setProcessIdInPartition( partId );
        pt.setNeighborPartitionIds( ghosts );
        this-&gt;addPoint( pt );
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Nodes are composed of several elements we will describe here :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>An id, named <strong>ptid</strong></p>
</li>
<li>
<p>A pair of coordinates, <strong>coords</strong>, which refer to its space position</p>
</li>
<li>
<p>A <strong>ProcessId</strong> equals to the id of the processor the node belongs</p>
</li>
<li>
<p>A <strong>ProcessIdInPartition</strong> equals to the id of the processor we currently work on</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>We choose here to define nodes present at internal boundaries, i.e at interfaces between processors, apart, in case of specific actions we could realise on them.</p>
</div>
<div class="paragraph">
<p>For left interfaces</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cpp hljs" data-lang="cpp">// First column
if(partId &gt; 0)
{
    int j = cx[partId];
    std::cout &lt;&lt; "j = " &lt;&lt; j &lt;&lt; std::endl;
    ghosts.clear();
    ghosts.push_back(partId-1);
    for( int i = 0; i &lt; M_nx; ++i )
    {
        // point
        int ptid = (M_ny)*i+j;
        //std::cout &lt;&lt; "ptId = " &lt;&lt; ptid &lt;&lt; std::endl;
        coords[0]=M_pixelsize*j;
        coords[1]=M_pixelsize*i;
        point_type pt( ptid,
                       coords,
                       i == 0 || i == M_nx-1
                       || j%((M_ny-1)/procSize) == 0 );
                       // Is on boundary ?

        pt.setMarker(1);
        // Actual rank ID
        pt.setProcessId( -1 );
        pt.setProcessIdInPartition( partId );
        pt.setNeighborPartitionIds( ghosts );
        this-&gt;addPoint( pt );
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>and for the right ones</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cpp hljs" data-lang="cpp">// Last columnif(partId &lt; (procSize-1))
{
    int j = cx[partId+1];
    //std::cout &lt;&lt; "j = " &lt;&lt; j &lt;&lt; std::endl;
     ghosts.clear();
    ghosts.push_back(partId+1);
    for( int i = 0; i &lt; M_nx; ++i )
    {
        // point
        int ptid = (M_ny)*i+j;
        //std::cout &lt;&lt; "ptId = " &lt;&lt; ptid &lt;&lt; std::endl;
        coords[0]=M_pixelsize*j;
        coords[1]=M_pixelsize*i;
        point_type pt( ptid,
                       coords,
                       i == 0 || i == M_nx-1
                        || j%((M_ny-1)/procSize) == 0 );
        // Is on boundary ?
        pt.setMarker(1);
        // Actual rank ID
        pt.setProcessId( partId );
        pt.setProcessIdInPartition( partId );
        pt.setNeighborPartitionIds( ghosts );
        this-&gt;addPoint( pt );
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>One of the main difference is that we set <strong>NeighborPartitionIds</strong> as we know we are at the interface with an another processor and we know its id.</p>
</div>
</div>
<div class="sect4">
<h5 id="_elements"><a class="anchor" href="#_elements"></a>Elements</h5>
<div class="paragraph">
<p>The elements are then defined</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cpp hljs" data-lang="cpp">/*
* Generates elements whithout ghosts
*/
tic();
for( int j = cx[partId]; j &lt; cx[partId+1]; ++j )
{
    ghosts.clear();
    if (j == cx[partId] &amp;&amp; j != 0)
        ghosts.push_back(partId-1);
    else if (j == cx[partId+1]-1 &amp;&amp; j != M_ny-2)
        {
            ghosts.push_back(partId+1);
        }
    for( int i = 0; i &lt; M_nx-1; ++i )
    {
        element_type e;
        int eid = (M_ny-1)*i+j; // GMSH Id

        e.setId( eid ); // eid == gmsh id
        e.setProcessIdInPartition( partId );
        e.setProcessId( partId );
        e.setMarker(1);
        e.setNeighborPartitionIds( ghosts );


        // points definition
        int ptid[4] = { (M_ny)*(i+1)+j, // 0
                        (M_ny)*(i+1)+j+1, // 1
                        (M_ny)*i+j+1, // 2
                        (M_ny)*i+j // 3
                      };

        for( int k = 0; k &lt; 4; ++k )
        {
            e.setPoint( k, this-&gt;point( ptid[k] ) );
        }
        e.setOnBoundary( i==0 || i==(M_nx-2)
                         || j%((M_ny-2)/procSize)==0 );
        // true -&gt; id = global elt id
        // false -&gt; id = local elt id
        this-&gt;addElement( e, true );
        // e.id() is modified to Feel++ Id
        __idGmshToFeel.insert( std::make_pair(eid,e.id()));
        // e.id() == Feel++ Id
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>First at all we define the possible processors id that can be neighborhood to the ones we want to build. We can obtain this information with the value of <strong>j</strong>, our horizontal unknown.</p>
</div>
<div class="paragraph">
<p>After that we build the several part of an element :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>An id, named <strong>eid</strong></p>
</li>
<li>
<p>A <strong>ProcessId</strong> equals to the id of the processor the node belongs</p>
</li>
<li>
<p>A <strong>ProcessIdInPartition</strong> equals to the id of the processor we currently work on</p>
</li>
<li>
<p>A set of points, <strong>ptid</strong>, which refer to nodes of our element. In this case, we work with square ( hypercube in 2D ) so we have four points.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>We also fill a map, <strong>__idGmshToFeel</strong>, that will make the connection between GMSH Id and Feel Id.</p>
</div>
</div>
<div class="sect4">
<h5 id="_timing_result"><a class="anchor" href="#_timing_result"></a>Timing Result</h5>
<div class="paragraph">
<p>The mesh built time obtain after this is equal to</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cpp hljs" data-lang="cpp">[Mesh built] Time : 11.2078s</code></pre>
</div>
</div>
<div class="paragraph">
<p>This time is decomposed as</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cpp hljs" data-lang="cpp">Timer                                                       Count    Total(s)      Max(s)      Min(s)     Mean(s)   StdDev(s)
Mesh built                                                      1    1.12e+01    1.12e+01    1.12e+01    1.12e+01    0.00e+00
Mesh::updateForUse update geomap cache                        1    7.00e-02    7.00e-02    7.00e-02    7.00e-02    0.00e+00
Mesh::updateForUse update setMesh in elements and faces       1    2.85e-01    2.85e-01    2.85e-01    2.85e-01    0.00e+00
MeshStructured Elements                                       1    6.60e+00    6.60e+00    6.60e+00    6.60e+00    0.00e+00
MeshStructured Nodes                                          1    3.52e+00    3.52e+00    3.52e+00    3.52e+00    0.00e+00</code></pre>
</div>
</div>
<div class="paragraph">
<p>We gain \(\simeq 30 s\) from using only the update field and \(\simeq 60 s\) from the original resolution.</p>
</div>
</div>
</div>
</div>
</div>
</div>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>

  </div>
</main>
</div>
<footer class="footer">
  <div class="container">
    <div class="footer-links">
      <div class="col">
        <div class="footer-logo">
          <a href="https://www.cemosis.fr" class="icon">
            <img src="../../../_/img/logoCemosisTransparent.png" alt="Cemosis">
          </a>
        </div>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://docs.cemosis.fr" target="_blank" rel="noopener">Projects Documentation</a></li>
          <li><a href="https://join.slack.com/t/feelpp/shared_invite/zt-2qe0q9hw-4pVbhohCXUE6Po9Ma8dbiQ" target="_blank" rel="noopener">Forums(Slack)</a></li>
        </ul>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://www.cemosis.fr" target="_blank" rel="noopener">Cemosis</a></li>
          <li><a href="https://www.cemosis.fr/news" target="_blank" rel="noopener">News</a></li>
          <li><a href="https://www.cemosis.fr/projects" target="_blank" rel="noopener">Projects</a></li>
        </ul>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://docs.feelpp.org" target="_blank" rel="noopener">Feel++ Documentation</a></li>
          <li><a href="http://docs.feelpp.org/user/">Get Started</a></li>
          <li><a href="http://docs.feelpp.org/user//install/distributions/">Downloads</a></li>
        </ul>
      </div>
      <div class="col">
        <ul class="social-icons">
          <li>
            <svg  width="14" height="14" viewBox="0 0 32 32"> <path id="facebook" class="cls-1" d="M29,0H3A2.652,2.652,0,0,0,0,3V29a2.652,2.652,0,0,0,3,3H16V18H12V14h4V12a6.452,6.452,0,0,1,6-6h4v4H22a2.151,2.151,0,0,0-2,2v2h6l-1,4H20V32h9a2.652,2.652,0,0,0,3-3V3A2.652,2.652,0,0,0,29,0Z"/></svg>
            <a href="https://www.facebook.com/cemosis.fr" class="icon">
            Facebook
            </a>
          </li>
          <li>
            <svg  width="14" height="14" viewBox="0 0 32.1 26.1"> <path id="twitter" class="cls-1" d="M32,7.1a11.836,11.836,0,0,1-3.8,1,6.462,6.462,0,0,0,2.9-3.6,12.606,12.606,0,0,1-4.2,1.6A6.492,6.492,0,0,0,22.1,4a6.594,6.594,0,0,0-6.6,6.6,7.719,7.719,0,0,0,.2,1.5A18.458,18.458,0,0,1,2.2,5.2a6.294,6.294,0,0,0-.9,3.3A6.765,6.765,0,0,0,4.2,14a6.109,6.109,0,0,1-3-.8v.1a6.543,6.543,0,0,0,5.3,6.4,4.678,4.678,0,0,1-1.7.2,4.869,4.869,0,0,1-1.2-.1,6.679,6.679,0,0,0,6.1,4.6,12.917,12.917,0,0,1-8.2,2.8,9.151,9.151,0,0,1-1.6-.1,18.438,18.438,0,0,0,10.1,3c12.1,0,18.7-10,18.7-18.7v-.8A13.336,13.336,0,0,0,32,7.2Z" transform="translate(0.1 -4)"/></svg>
            <a href="https://twitter.com/cemosis" class="icon">
              Twitter
            </a>
          </li>
          <li>
          <svg  width="14" height="14" viewBox="0 0 32 32"> <path id="linkedin" class="cls-1" d="M29,0H3A3.076,3.076,0,0,0,0,3V29a3.009,3.009,0,0,0,3,3H29a2.946,2.946,0,0,0,3-3V3A3.009,3.009,0,0,0,29,0ZM12,26H8V12h4ZM10,10a2,2,0,1,1,2-2A2.006,2.006,0,0,1,10,10ZM26,26H22V18a2,2,0,0,0-4,0v8H14V12h4v2.5c.8-1.1,2.1-2.5,3.5-2.5A4.736,4.736,0,0,1,26,17Z"/></svg>
              <a href="https://www.linkedin.com/company/cemosis" class="icon">
             Linkedin
            </a>
          </li>
        </ul>
      </div>
    </div>
    <div class="footer-terms">
      <div class="footer-terms-copyright">
          <span>© 2020 Cemosis, Université de Strasbourg</span>
      </div>
      <div class="footer-terms-links">
        <a href="https://www.cemosis.fr/terms-of-use">Terms of Use</a>
        <a href="https://www.cemosis.fr/privacy-policy">Privacy Policy</a>
        <a href="https://www.cemosis.fr/cookie-policy">Cookie Policy</a>
        <a href="https://www.cemosis.fr/support-policy">Support Policy</a>
      </div>
    </div>
  </div>
</footer>
<script src="../../../_/js/site.js"></script>
<script async src="../../../_/js/vendor/fontawesome-icon-defs.js"></script>
<script async src="../../../_/js/vendor/fontawesome.js"></script>
<script async src="../../../_/js/vendor/highlight.js"></script>

<script async id="search-script" src="../../../_/js/vendor/docsearch.js" data-app-id="FIPLENFG5M" data-api-key="489d96aa4ae574ec7ad1f23741a2d46d" data-index-name="cemosis" data-stylesheet="../../../_/css/vendor/docsearch.css">
</script>

  </body>
</html>
