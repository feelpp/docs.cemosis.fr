<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Surface reconstruction internship :: Cemosis Docs</title>
    <link rel="canonical" href="https://docs.cemosis.fr/holo3/latest/appendix/internship/surface_reconstruction/README.html">
    <meta name="generator" content="Antora 2.3.3">
    <link rel="stylesheet" href="../../../../../_/css/site.css">
<link rel="icon" href="../../../../../_/img/favicon.ico" type="image/x-icon">    
<script>!function(l,p){if(l.protocol!==p&&l.host=="docs.antora.org"){l.protocol=p}else if(/\.gitlab\.io$/.test(l.host)){l.replace(p+"//docs.antora.org"+l.pathname.substr(l.pathname.indexOf("/",1))+l.search+l.hash)}}(location,"https:")</script>






<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  messageStyle: "none",
  tex2jax: {
    inlineMath: [['$','$'], ['\\(','\\)']],
    displayMath: [['$$','$$'], ['\\[','\\]']],
    processEscapes: true,
    processEnvironments: true, 
    ignoreClass: "nostem|nolatexmath"
  },
  asciimath2jax: {
    delimiters: [["\\$", "\\$"]],
    ignoreClass: "nostem|noasciimath"
  },

  TeX: {
      Macros: {
      RR: "{\\mathbb R}",
      NN: "{\\mathbb N}",
      Nso: "{N_{\\mathrm{so}}}",
      Nma: "{N_{\\mathrm{ma}}}",
      Nno: "{N_{\\mathrm{no}}}",
      Ne: "{N_{\\mathrm{e}}}",
      Ilag: ["{\\mathcal{I}^{\\mathrm{lag}}_{#1}}",1],
      calTh: "{\\mathcal{T}_h}",
      Ck: ["{\\mathcal{C}^{#1}}",1],
      Pk: ["{\\mathcal{P}^{#1}}",1],
      Qk: ["{\\mathcal{Q}^{#1}}",1],
      Pch: ["{P^{#1}_{c,h}}",1],
      Pcho: ["{P^{#1}_{c,h,0}}",1],
      Qch: ["{Q^{#1}_{c,h}}",1],
      Ich: ["{\\mathcal{I}^{#1}_{c,h}#2}",2],
      poly: ["{\\mathbb{#1}}",1],
      nf: "{n_f}",
      ngeo: "{n_{\\mathrm{geo}}}",
      geo: "{\\mathrm{geo}}",
      card: ["{\\operatorname{card}(#1)}",1],
      dim: ["{\\operatorname{dim}(#1)}",1],
      opdim: "{\\operatorname{dim}}",
      card: ["{\\operatorname{card}(#1)}",1],
      poly: ["{\\mathbb{#1}",1],
      R: ["{\\mathbb{R}^{#1}}",1],
      set: ["{\\left\\{#1\\right\\}}",1],
      diam: "{\\operatorname{diam}}",
      jump: ["{[\\![ #1 ]\\!]}",1],
      Next: "{\\mathrm{n}}",
      essinf: "{\\operatorname{ess}\\, \\operatorname{inf}}",
      tr: "{\\operatorname{tr}}",
      Id: "{\\mathcal{I}}",
      disp: ["{\\mathbf{#1}}",1],
      stresst: ["{\\mathbf{\\sigma(#1)}}",1],
      deformt: ["{\\mathbf{\\varepsilon(#1)}}",1],
      domain: "{\\Omega}",
      prect: ["{\\left\\(#1\\right\\)}",1],
      ds: "",
      bold: ["{\\bf #1}",1],
      p: "{\\mathrm{p}}",
      q:"{\\mathbf{q}}",
      n:"{\\mathbf{n}}",
      T:"{\\mathcal{T}}",
      F:"{\\mathcal{F}}",
      P:"{\\mathcal{P}}",
      v:"{\\mathbf{v}}"
  },
  extensions: ["mhchem.js"] }
});
</script>
<!--<script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.3/MathJax.js?config=TeX-MML-AM_CHTML"></script>-->
<!-- <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML' async></script> -->
<script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS_CHTML'>
</script>
<!--<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.6.0/MathJax.js?config=TeX-MML-AM_HTMLorMML"></script>-->

<!--<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.9.0/katex.min.css" integrity="sha384-TEMocfGvRuD1rIAacqrknm5BQZ7W7uWitoih+jMNFXQIbNl16bO8OZmylH/Vi/Ei" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.9.0/katex.min.js" integrity="sha384-jmxIlussZWB7qCuB+PgKG1uLjjxbVVIayPJwi6cG6Zb4YKq0JIw+OMnkkEC7kYCq" crossorigin="anonymous"></script>-->

    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-65761593-2"></script>
    <script>function gtag(){dataLayer.push(arguments)};window.dataLayer=window.dataLayer||[];gtag('js',new Date());gtag('config','UA-65761593-2')</script>
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar  navbar-expand-sm bg-dark navbar-dark">
    <div class="navbar-brand">
      <div class="navbar-item">
         <!--  <a href="https://book.feelpp.org">Feel++ documentation</a> -->
           <a href="https://docs.cemosis.fr">Cemosis Docs</a>
      </div>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://docs.cemosis.fr">Home</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <div class="navbar-link">Docs</div>
          <div class="navbar-dropdown">
            <div class="navbar-item"><strong>Latest Version</strong></div>

            <!-- this code allow to manage ordering of navbar item -->
               
              <a class="navbar-item" href="/cemosis/latest/index.html"> Cemosis Documentation </a>
                  
              <a class="navbar-item" href="/antora-ui-default/index.html"> Cemosis Documentation UI </a>
                  
              <a class="navbar-item" href="/eye2brain/current/index.html"> Eye2Brain Manual </a>
                  
              <a class="navbar-item" href="/feelpp-cfd/latest/index.html"> Feel++ CFD </a>
                  
              <a class="navbar-item" href="/mqs/latest/index.html"> Feel++ Maxwell Quasi Static </a>
                  
              <a class="navbar-item" href="/hemotumpp/0.1/index.html"> HemoTum++ </a>
                  
              <a class="navbar-item" href="/hifimagnet/stable/index.html"> HiFiMagnet Documentation </a>
                  
              <a class="navbar-item" href="/holo3/latest/index.html"> Holo3 </a>
                    
              <a class="navbar-item" href="/ibat/latest/index.html"> IBat Docs </a>
                  
              <a class="navbar-item" href="/msqab/latest/index.html"> msqab </a>
                  
              <a class="navbar-item" href="/swimmer/latest/index.html"> Swimmer Docs </a>
               

            <hr class="navbar-divider">
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <div class="navbar-link">Feel++</div>
          <div class="navbar-dropdown">
            <div class="navbar-item"><strong>GitHub</strong></div>
            <a class="navbar-item" href="http://github.com/feelpp/feelpp">GitHub Repository</a>
            <a class="navbar-item" href="http://github.com/feelpp/feelpp/issues">GitHub Issue Tracker</a>
            <hr class="navbar-divider">
            <div class="navbar-item"><strong>Documentation</strong></div>
            <a class="navbar-item" href="http://docs.feelpp.org/user/">User Manual</a>
            <a class="navbar-item" href="http://docs.feelpp.org/dev/">Developer Manual</a>
            <a class="navbar-item" href="http://docs.feelpp.org/toolbox/">Toolbox Manual</a>
            
          </div>
        </div>
        <div class="primary-action">
            <form class="navbar-item search">
              <input type="text" placeholder="Search Cemosis Docs" class="query" id="search-query">
              <button type="button" class="search-btn"><i class="fas fa-search"></i></button>
            </form>
        </div>
        <div class="navbar-item">
          <a class="navbar-brand" href="https://join.slack.com/t/feelpp/shared_invite/zt-2qe0q9hw-4pVbhohCXUE6Po9Ma8dbiQ">
            <img src="../../../../../_/img/slack.png" alt="slack" style="width:30px;"></a>
        </div>
        <div class="navbar-item">
          <a class="navbar-brand"  href="http://docs.feelpp.org">
            <img src="../../../../../_/img/logoFeelpp.png" alt="Feel++" style="width:60px;">
          </a>
        </div>
        <div class="navbar-item">
          <a class="navbar-brand"  href="http://www.cemosis.fr">
            <img src="../../../../../_/img/logoCemosisTransparent.png" alt="Cemosis" style="width:60px;">
          </a>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="holo3" data-version="latest">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../../../index.html">Holo3</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../../modeling/deflectometry.html">Introduction</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../../polymap/polymap.html">Polymap</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../../methodology/index.html">Methodology</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Domain Definition</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../../methodology/uniformmesh.html">Uniform mesh</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../../methodology/deformedmesh.html">Deformed mesh</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../../methodology/meshpoly.html">Mesh extraction with polygons</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../../methodology/meshls.html">Mesh extraction with levelset</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Reconstruction</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../../methodology/problemformulation.html">Problem formulation</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../../methodology/meshoptimization.html">Mesh optimization</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../../methodology/nonlinearproblem.html">Non linear problem</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../../methodology/solver.html">Solver</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../../methodology/serialcontrol.html">Serial control</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Data Selection</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../../indicators/indicators.html">Indicators</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../../../indicators/low-contrast.html">Low Contrast</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../../../indicators/phase-spike.html">Phase Spike</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../../../indicators/phase-border.html">Phase Border</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../../../indicators/combine.html">Indicators combined</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#methodology/mesureetalon.adoc">Mesure Etalon</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../../client-server/index.html">Client Server</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Numerical Experiments</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../../experiments/serialbench.html">Serial Benchmark</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../../experiments/standardbench.html">Standard Benchmark</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../../experiments/testsuite.html">Testsuite</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../../experiments/validation.html">Validation</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Report</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../../report/report.html">Report 2020</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Holo3</span>
    <span class="version">latest</span>
  </div>
  <ul class="components">
    <li class="component">
      <span class="title">Cemosis Documentation</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../../../cemosis/latest/index.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">Cemosis Documentation UI</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../../../antora-ui-default/index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">Eye2Brain Manual</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../../../eye2brain/current/index.html">current</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">Feel++ CFD</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../../../feelpp-cfd/latest/index.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">Feel++ Maxwell Quasi Static</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../../../mqs/latest/index.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">HemoTum++</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../../../hemotumpp/0.1/index.html">0.1</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">HiFiMagnet Documentation</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../../../hifimagnet/stable/index.html">stable</a>
        </li>
      </ul>
    </li>
    <li class="component is-current">
      <span class="title">Holo3</span>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../../../index.html">latest</a>
        </li>
        <li class="version">
          <a href="../../../../doc-pierre/index.html">doc-pierre</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">IBat Docs</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../../../ibat/latest/index.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">msqab</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../../../msqab/latest/index.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">Swimmer Docs</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../../../swimmer/latest/index.html">latest</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../../../../../cemosis/latest/index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../../../index.html">Holo3</a></li>
    <li><a href="README.html">Surface reconstruction internship</a></li>
  </ul>
</nav>
<div class="page-versions">
  <button class="version-menu-toggle" title="Show other versions of page">latest</button>
  <div class="version-menu">
    <a class="version is-current" href="README.html">latest</a>
    <a class="version" href="../../../../doc-pierre/appendix/internship/surface_reconstruction/README.html">doc-pierre</a>
  </div>
</div>
</div>
  <div class="content">
<article class="doc">
<h1 class="page">Surface reconstruction internship</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>This internship, been realised by Benjamin Vanthong at Holo3, involves in a first place to implement a code which allow refelcting surface reconstruction from slope datas. These are obtained by deflectometry from "Holomap", a device using Feel++ , a library specialized into differential equations resolution by finite elements.
In a second time, a meshing tool, in order to take in account noise or empty areas, will be create.</p>
</div>
<div class="paragraph">
<p>The MARMA ( Méthodologie d&#8217;Analyse des Revêtement Autocicatrisants ) project, from the collaboration between Holo3 and Institut Charles Chardon, give the opportunity to develop the Holomap device, used to call accurately the auto-healing capacity of coating after stripped.</p>
</div>
</div>
</div>
<h1 id="_surface_reconstruction" class="sect0"><a class="anchor" href="#_surface_reconstruction"></a>Surface reconstruction</h1>
<div class="paragraph">
<p>The method, retained by Pierre Danieau, is the finite element one because it&#8217;s less likely to spread errors. Let&#8217;s interest us first to the variational formula of the surface reconstruction problem we want to solve, then how we can impelment it in Feel++.</p>
</div>
<div class="sect1">
<h2 id="_variational_formula"><a class="anchor" href="#_variational_formula"></a>1. Variational formula</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Let p and q the slopes according respectively to the x and the y axis. For each test functionv, the solution of the following problem give us the height z from the surface we want to rebuild :</p>
</div>
<div class="paragraph">
<p>
\int_\Omega \Delta z v = \int_\Omega \nabla\cdot((p,q))v
</p>
</div>
<div class="paragraph">
<p>By the use of Green formula on the left member :</p>
</div>
<div class="paragraph">
<p>
\int_\Omega \Delta z v = -\int_\Omega \nabla z \cdot \nabla v + \int_{\partial\Omega}\frac{\partial z}{\partial n} v
</p>
</div>
<div class="paragraph">
<p>And the same on the right member :</p>
</div>
<div class="paragraph">
<p>
\int_\Omega \nabla\cdot ((p,q)) v = -\int_\Omega(p,q)\cdot\nabla v + \int_{\partial\Omega}(p,q)\cdot\vec{n}v
</p>
</div>
<div class="paragraph">
<p>We have then :</p>
</div>
<div class="paragraph">
<p>
-\int_\Omega \nabla z \cdot \nabla v + \int_{\partial\Omega}\frac{\partial z}{\partial n} v =-\int_\Omega(p,q)\cdot\nabla v + \int_{\partial\Omega}(p,q)\cdot\vec{n}v
</p>
</div>
<div class="paragraph">
<p>We can notice that :</p>
</div>
<div class="paragraph">
<p>
\int_{\partial\Omega}\frac{\partial z}{\partial n} v = \int_{\partial\Omega}(p,q)\cdot\vec{n}v
</p>
</div>
<div class="paragraph">
<p>Finally, we obtain the weak formula :</p>
</div>
<div class="paragraph">
<p>
\int_\Omega \nabla z \cdot \nabla v = \int_\Omega(p,q)\cdot\nabla v
</p>
</div>
<div class="paragraph">
<p>Now that we had studied the theorical approach, let see how we can introduce this in Feel++.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_numerical_approach"><a class="anchor" href="#_numerical_approach"></a>2. Numerical approach</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In the previous paragraph, the mathematical approach give us the variational formula on its weak form, that we will implement with Feel++</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Loading slopes data from images using the format \emph{.hbf} (Holo3 Binary File)</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cpp hljs" data-lang="cpp">x = readHBF( soption(_name="hbf1") );
y = readHBF( soption(_name="hbf2") );</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Creating the mesh form images dimensions</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cpp hljs" data-lang="cpp">auto mesh = createGMSHMesh( _mesh=new Mesh&lt;Hypercube&lt;2&gt;&gt;,
                            _structured=1,
                            _h=doption(_name="pixelsize"),
                            _desc=domain(_name="polymere",
                            _xmax=(x.cols()-1)*doption(_name="pixelsize"),
                            _ymax=(x.rows()-1)*doption(_name="pixelsize")));</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Converting slopes data into scalar fields that Feel++ can understand</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cpp hljs" data-lang="cpp">const int nx = x.cols();
const int ny = x.rows();
Hbf2Feelpp h2f( nx, ny, Vh );
auto px = h2f( x );
auto py = h2f( y );</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Implementing the variational formula</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cpp hljs" data-lang="cpp">auto a = form2( _trial=Vh, _test=Vh);
a = integrate( _range=elements(mesh),
               _expr=gradt(u)*trans(grad(v)));

auto l = form1( _test=Vh );
l = integrate(_range=elements(mesh),
              _expr=grad(v)*vec(idv(px),idv(py)));</code></pre>
</div>
</div>
<div class="paragraph">
<p>\item Finding the solution</p>
</div>
<div class="listingblock">
<div class="content">
<pre>a.solve(_rhs=l,_solution=u) ;</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Exporting data in order to observe the rebuild surface with the help of Paraview</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>auto e = exporter( _mesh=mesh );
e-&gt;add( "u", u );
e-&gt;add( "px", px );
e-&gt;add( "py", py );
e-&gt;save();</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Exporting data with the .hbf format ( work only with sequential )</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>auto z = h2f(u);
writeHBF( "z.hbf", z );</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_tests_and_results"><a class="anchor" href="#_tests_and_results"></a>3. Tests and results</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this part, we will rebuild the surface from the program previously explained, with the following slopes data :</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../../Pictures/px_image_sr.png" alt="px image sr">
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="../../../Pictures/py_image_sr.png" alt="py image sr">
</div>
</div>
<div class="paragraph">
<p>That give us :</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../../../../Pictures/result2D_sr.png" alt="result2D sr">
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="../../../../../Pictures/result3D_sr.png" alt="result3D sr">
</div>
</div>
<div class="paragraph">
<p>We observe on this two rebuilds two stripes of 0.4-mm diameter and 0.03-mm amplitude, and two cavities of 0.2-mm diameter and 0.04-mm depth. This result is conform to the surface we wanted.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_performance_test"><a class="anchor" href="#_performance_test"></a>4. Performance test</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The Feel++ library have three different solvers : LU, ML ( Multi Level ) and GAMG ( Geometric-Algebraic Multi-Grid ). With them, we will test our surface reconstruction program. Here are the different calculation times for each solvers from hbf files sizeable 1280 \times 960 with one processor :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>LU solver : 350.3288 s, 4 iterations</p>
</li>
<li>
<p>ML solver : 12.4778 s, 22 iterations</p>
</li>
<li>
<p>GAMG solver : 39.0989 s, 67 iterations</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Observation :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>ML solver is twenty times faster that the default one, the LU solver.</p>
</li>
<li>
<p>The time used to generate the mesh ( \approx 130s ) is important but can be improved by parallelization.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_parallelization"><a class="anchor" href="#_parallelization"></a>5. Parallelization</h2>
<div class="sectionbody">
<div class="paragraph">
<p>All the Feel++ functionalities we used in the surface reconstruction code are already parallelized. In this case, the function readHBF, which let us read a .hbf file, is the only one we need to make parallel to launch the code on multiple processors, and so gain calculation time. To realize this, we simply read it as before, with one processor, but we distribute on all the other processor by the broadcast method from the MPI library ( Message Passing Interface ) :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cpp hljs" data-lang="cpp">if( Environment::worldComm().isMasterRank() ) {
        x = readHBF( soption(_name="hbf1") );
            y = readHBF( soption(_name="hbf2") );
}
boost::mpi::broadcast(Environment::worldComm(), x, 0);
boost::mpi::broadcast(Environment::worldComm(), y, 0);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The ideal solution would be to modify the readHBF function code to realize directly the parallel reading of .hbf files.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_issue"><a class="anchor" href="#_issue"></a>6. Issue</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The surface reconstruction code is operational, as long as the desired surface is enough regular. In real cases, surfaces we want to measure can have holes, discontinuities ( as stripes, &#8230;&#8203; ), etc.</p>
</div>
<div class="paragraph">
<p>In the following example, we add a discontinuity represent by a slanted line on the previous studied data. After reconstruction, we obtain :</p>
</div>
<div class="paragraph">
<p>We can note a difference of height, while the surface is supposed flat.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../../../../Pictures/result2D_srt.png" alt="result2D srt">
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="../../../../../Pictures/result3D_srt.png" alt="result3D srt">
</div>
</div>
<div class="paragraph">
<p>A possible solution too fix this problem is to give to the user the possibility to select an area of interst to exclude the unwnated areas. At this moment, the possible select area can only be rectangular. However, this isn&#8217;t enough to select specific areas, like areas non-parallel to the camera.
That&#8217;s why Holo3 ( in particular Pierre Danieau ) ask to create a tool, which can select every area with a polygon, and subsequently, a tool to detect automatically areas without informations.</p>
</div>
</div>
</div>
<h1 id="_interest_area_selection" class="sect0"><a class="anchor" href="#_interest_area_selection"></a>Interest area selection</h1>
<div class="paragraph">
<p>In this chapter, we will start to describe the functionalities of the application for the interest area selection, then we will detail the implementation which extract the associated submesh.</p>
</div>
<div class="sect1">
<h2 id="_gui"><a class="anchor" href="#_gui"></a>1. GUI</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The graphical interface has been develop with the <strong>Qt</strong> framework for the window build and the <strong>opencv</strong> library for the images manipulation.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../../../../Pictures/gui.png" alt="gui">
</div>
</div>
<div class="paragraph">
<p>The slopes data measured by Holomap can sometimes present noise areas, or even areas without data. It&#8217;s more convenient to exclude them during the surface reconstruction operations. The graphical interface allow the user to select the interest regions, but excluding the unwanted areas.</p>
</div>
<div class="sect2">
<h3 id="_features"><a class="anchor" href="#_features"></a>1.1. Features</h3>
<div class="sect3">
<h4 id="_input"><a class="anchor" href="#_input"></a>1.1.1. Input</h4>
<div class="paragraph">
<p>The application take in entry two files .hbf with same size. They contain the slopes of the x and y axis of the wanted reconstruted surface.</p>
</div>
</div>
<div class="sect3">
<h4 id="_selection"><a class="anchor" href="#_selection"></a>1.1.2. Selection</h4>
<div class="paragraph">
<p>An interest area is define by a polygon, which the vertices are chosen by the user by clicking on the image with the left mouse button. To end the selection, a single right mouse click is need.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../../../../Pictures/roiSelection.png" alt="roiSelection">
</div>
</div>
<div class="paragraph">
<p>It also possible to repeat the manipulation to select other polygons on the same image.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../../../../Pictures/roiSelection2.png" alt="roiSelection2">
</div>
</div>
<div class="paragraph">
<p>At the contrary, the user can also switch to the exclusion mode to select this time the areas he want to exclude.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../../../../Pictures/roiSelection3.png" alt="roiSelection3">
</div>
</div>
</div>
<div class="sect3">
<h4 id="_removal"><a class="anchor" href="#_removal"></a>1.1.3. Removal</h4>
<div class="paragraph">
<p>By pressing the Delete button, the user have the possibilty to erase the last selected polygon. The Reset button is used to erase all the polygon in memory.</p>
</div>
</div>
<div class="sect3">
<h4 id="_output"><a class="anchor" href="#_output"></a>1.1.4. Output</h4>
<div class="paragraph">
<p>When the user have finished to select the interest areas, he can save the coordinates of the polygons, that compose the whole wanted area, into a .txt file.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-txt hljs" data-lang="txt">NOMBRE_TOTAL_DE_POLYGONE
NOMBRE_DE_SOMMET_POUR_LE_POLYGON_1
x1 y1
x2 y2
...
NOMBRE_DE_SOMMET_POUR_LE_POLYGON_2
x1 y1
x2 y2
x3 y3
...
NOMBRE_DE_SOMMET_POUR_LE_POLYGON_3
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Example :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-txt hljs" data-lang="txt">3
4
0 132.812
207.031 0
699.219 363.281
191.406 589.844
4
376.953 734.375
382.812 607.422
589.844 611.328
650.391 773.438
3
658.203 589.844
681.641 453.125
890.625 378.906</code></pre>
</div>
</div>
<div class="paragraph">
<p>Furthermore, the application will save two .hbf files of the slopes data by cutting the minimal rectangular surface, that can contain all the drawn polygons of the interest region :</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../../../../Pictures/roiSelection4.png" alt="roiSelection4">
</div>
</div>
<div class="paragraph">
<p>In the exclusion mode, the size of the .hbf files will still be the same.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_mesh_extraction"><a class="anchor" href="#_mesh_extraction"></a>2. Mesh extraction</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now that we have the coordinates of the polygons vertices of the interest region, see how we will extract this submesh. The easiest way is to differentiate the degree of freedom inside and outside the selected region. To do this, we will estimate for each degree of freedom the distance which separate it to the most close polygon. However, points inside polygons will have a negative value equal to the distance between this point and the nearby edge of the polygon.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../../../../Pictures/polyCurve.png" alt="polyCurve">
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="../../../../../Pictures/polyCurve2.png" alt="polyCurve2">
</div>
</div>
<div class="paragraph">
<p>We can now distinguish elements in the interest region, they can be marked in Feel++ with \textbf{marker2}, then we can extract the mesh.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cpp hljs" data-lang="cpp">auto polygon = vf::project(Xh1, elements(mesh), idf(functor) );
auto marker = boption(_name="exclusion")
    ? vf::project (Xh0, elements(mesh), chi(idv(polygon) &lt;= cst(0.)))
    : vf::project(Xh0, elements(mesh), chi(idv(polygon) &gt; cst(0.))) ;
mesh -&gt;updateMarker2(marker) ;
auto submesh = createSubmesh(mesh, marked2elements(mesh,doption("parameters.a"))) ;</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="../../../../../Pictures/meshCurve.png" alt="meshCurve">
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="../../../../../Pictures/meshCurve2.png" alt="meshCurve2">
</div>
</div>
<div class="paragraph">
<p>Feel++ keeps the realtion between meshes, that is in order words that if we have a data on the initial complete mesh, we can use it on the new extract mesh. That allow us to reuse the surface reconstrution code, we just have to change the integration domain.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_test_and_results"><a class="anchor" href="#_test_and_results"></a>3. Test and Results</h2>
<div class="sectionbody">
<div class="paragraph">
<p>By using the graphical interface, we will select the discontinuity area, which give us some issues in the previous example, to exclude it from the reconstrution.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../../../../Pictures/intergraphe.png" alt="intergraphe">
</div>
</div>
<div class="paragraph">
<p>The result of the reconstruction, without this discontinuity area, match with the surface we want to reconstrut.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../../../../Pictures/paraview_test.png" alt="paraview test">
</div>
</div>
</div>
</div>
<h1 id="_edges_automatic_detection" class="sect0"><a class="anchor" href="#_edges_automatic_detection"></a>Edges automatic detection</h1>
<div class="paragraph">
<p>The edges automatic detection principle is to consider a gray-level image as a two dimension scalar function, we will name it I(x,y). Find the edges of an image is equivalent to find the set of points (x,y) of the image where |\nabla I| is high. The strategy is to make evolve the zero-level ( also named spreading front ) of the levelset by applying a velocity u, that depend of the function I, into the normal direction of the front. The goal is, that at the end of the simulation, the front has to stall at the edges of the non-wanted areas of the image.</p>
</div>
<div class="sect1">
<h2 id="_theoric_approach"><a class="anchor" href="#_theoric_approach"></a>1. Theoric approach</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_levelset"><a class="anchor" href="#_levelset"></a>1.1. Levelset</h3>
<div class="paragraph">
<p>The evolution of the function levelset \phi with a velocity field u is the advection equation :</p>
</div>
<div class="paragraph">
<p>
\partial_t \phi + u\cdot\nabla \phi = 0.
</p>
</div>
<div class="paragraph">
<p>The variational formula of this equation is obtained by multiply it by a test function \psi \in H^1(\Omega) and by integrate it on all the domain \Omega. Then the problem become :</p>
</div>
<div class="paragraph">
<p>
\int_\Omega \partial_t\phi\psi + \int_\Omega (u\cdot\nabla\phi)\psi=0
</p>
</div>
</div>
<div class="sect2">
<h3 id="_discretization"><a class="anchor" href="#_discretization"></a>1.2. Discretization</h3>
<div class="paragraph">
<p>The numerical model of the previous equation will need to be discretize in time but also in space.</p>
</div>
<div class="sect3">
<h4 id="_time_discretization"><a class="anchor" href="#_time_discretization"></a>1.2.1. Time discretization</h4>
<div class="paragraph">
<p>The time discretization will be done with the Euler scheme :</p>
</div>
<div class="paragraph">
<p>
\partial_t\phi\approx\frac{\phi^{n+1}-\phi^n}{\Delta t}
</p>
</div>
<div class="paragraph">
<p>That give us :</p>
</div>
<div class="paragraph">
<p>
\int_\Omega \frac{\phi^{n+1}}{\Delta t}\psi + \int_\Omega (u^{n+1}\cdot\nabla\phi^{n+1})\psi=\int_\Omega \frac{\phi^n}{\Delta t}\psi
</p>
</div>
</div>
<div class="sect3">
<h4 id="_space_discretization"><a class="anchor" href="#_space_discretization"></a>1.2.2. Space discretization</h4>
<div class="paragraph">
<p>Denote \mathbb{R}^k_h the discretize finite element space where h is the mesh element mesh and k the Lagrange polynomial degree. The problem come back to find \phi_h \in \mathbb{R}^k_h as \forall \psi_h \in \mathbb{R}^k_h :</p>
</div>
<div class="paragraph">
<p>
\int_\Omega \frac{\phi_h^{n+1}}{\Delta t}\psi_h + \int_\Omega (u^{n+1}\cdot\nabla\phi_h^{n+1})\psi=\int_\Omega \frac{\phi_h^n}{\Delta t}\psi_h
</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_stabilization"><a class="anchor" href="#_stabilization"></a>1.3. Stabilization</h3>
<div class="paragraph">
<p>The discretize advection equation is instable due to possible occuring oscillations, that&#8217;s why we introduce the SUPG ( Streamline Upwind Petrov Galerkin ) method by adding a stability term at the precedent equation.</p>
</div>
<div class="paragraph">
<p>The three following terms are introduce to symplify the formula notation :</p>
</div>
<div class="paragraph">
<p>
\sigma=\frac{1}{\Delta t}


\beta=u^{n+1}


f=\frac{\phi^n}{\Delta t}
</p>
</div>
<div class="paragraph">
<p>This give us :</p>
</div>
<div class="paragraph">
<p>
\int_\Omega \sigma\phi_h^{n+1}\psi_h + \int_\Omega (\beta\cdot\nabla\phi_h^{n+1})\psi=\int_\Omega f\psi_h
</p>
</div>
<div class="paragraph">
<p>Let introduce the operator mathbb{L} = \beta \cdot \nabla + \sigma, it will simplify the stabilisation term writing. After introduce this term in the last equation, we obtain :</p>
</div>
<div class="paragraph">
<p>
\int_\Omega \mathcal{L}(\phi_h)\psi_h + \sum^{N_{elt}}_{K=1} S_K(\phi_h,\psi_h)=\int_\Omega f\psi_h
</p>
</div>
<div class="paragraph">
<p>where S_K(\phi_h,\psi_h) is the stabilization term for a discretize element K on the domain \Omega et N_{elt} the total number of elements.</p>
</div>
<div class="paragraph">
<p>
S_K=\int_\Omega \tau_K(\beta\cdot\nabla\psi_h)(\mathcal{L}(\phi_h) - f)
</p>
</div>
<div class="paragraph">
<p>with</p>
</div>
<div class="paragraph">
<p>
\tau_K = \frac{h}{2|\beta|}
</p>
</div>
<div class="sect3">
<h4 id="_fast_marching"><a class="anchor" href="#_fast_marching"></a>1.3.1. Fast Marching</h4>
<div class="paragraph">
<p>We use here the fast marching method to reinitialize ( or redistancing ) the function \phi at each iteration, in order to keep its distance function properties, i.e. |\nabla\phi|=1.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_advection_velocity_u"><a class="anchor" href="#_advection_velocity_u"></a>1.4. Advection velocity u</h3>
<div class="paragraph">
<p>The advection velocity is given by :</p>
</div>
<div class="paragraph">
<p>
u=\frac{1}{1+\alpha|\nabla I|}\frac{\nabla\phi}{|\nabla\phi}
</p>
</div>
<div class="paragraph">
<p>as \alpha a parameter the user has to define in fucntion of the surface case.</p>
</div>
<div class="paragraph">
<p>The advection velocity u correspond to the velocity at the interface level ( zero-level of the levelset ), that&#8217;s why we introduce the extended velocity, define by :</p>
</div>
<div class="paragraph">
<p>
u_e=\left\{ \begin{array}{ccc}
           u(x) $ if  $ x \in \Omega_{interface} \\
           u(x_{mindlist}) $ $ elsewhere \\
           \end{array}
           \right\.
</p>
</div>
<div class="paragraph">
<p>where</p>
</div>
<div class="paragraph">
<p>
x_{mindlist} \in \left\{ \Omega_{interface} | dist(x_{mindlist},x)= min_{x_1 \in \Omega_{interface}} dist(x_1,x) \right\}
</p>
</div>
<div class="paragraph">
<p>In other words, each element on the domain \Omega will have the same value as the nearest element on the interface \Omega_{interface} ( See the following image ).</p>
</div>
<div class="sect3">
<h4 id="_stop_condition"><a class="anchor" href="#_stop_condition"></a>1.4.1. Stop condition</h4>
<div class="paragraph">
<p>The velocity definition u ahead cannot allow it to reach zero, the value that will stop the interface when it will be in contact of a contour ( i.e. |\nabla I| big ). That&#8217;s why we introduce a minimal threshold u_{min} to reach in order to consider the velocity u is null :</p>
</div>
<div class="paragraph">
<p>
u_e'(x)=u_e(x)\chi(|u_e(x)|&gt; u_{min})
</p>
</div>
<div class="paragraph">
<p>with \chi the characteristic function.</p>
</div>
<div class="paragraph">
<p>The program will stop when the zero-level of the levelset will not move anymore, that is when the velocity on the interface will be null :</p>
</div>
<div class="paragraph">
<p>
\int_{\Omega_{interface}} u_e'(x)=0
</p>
</div>
<div class="paragraph">
<p>As we extend the velocity, we can integrate on the whole domain</p>
</div>
<div class="paragraph">
<p>
\int_{\Omega} u_e'(x)=0
</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_numerical_approach_2"><a class="anchor" href="#_numerical_approach_2"></a>2. Numerical approach</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Let see the algorithm we will use :</p>
</div>
<div class="paragraph">
<p>Levelset algorithm for edges detection</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Data loading</p>
</li>
<li>
<p>\phi init</p>
</li>
<li>
<p>do</p>
<div class="ulist">
<ul>
<li>
<p>Calculation of</p>
<div class="ulist">
<ul>
<li>
<p>velocity u</p>
</li>
<li>
<p>extend velocity u_e</p>
</li>
<li>
<p>u_e' from u_e with minimal thresold u_{min}</p>
</li>
</ul>
</div>
</li>
<li>
<p>Assembly of</p>
<div class="ulist">
<ul>
<li>
<p>bilinear form a + stabilization term</p>
</li>
<li>
<p>linear form l + stabilization term</p>
</li>
</ul>
</div>
</li>
<li>
<p>Advection equation solve</p>
</li>
<li>
<p>\phi recalculation</p>
</li>
</ul>
</div>
</li>
<li>
<p>while Stop condition</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_data_loading"><a class="anchor" href="#_data_loading"></a>2.1. Data loading</h3>
<div class="paragraph">
<p>Data we will load are slopes data from .hbf ( Holo3 Binary File ) files, given by the Micromap engine and the circle position put in unwanted areas.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Slopes data load following x and y axis. For the moment, we will only ise slopes data following x to define edges :</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cpp hljs" data-lang="cpp">holo3_image&lt;float&gt; x, y;
if( Environment::worldComm().isMasterRank() ) {
        x = readHBF( soption(_name="hbf1") );
            y = readHBF( soption(_name="hbf2") );
}</code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Circle coordinates data load, written like this :</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-txt hljs" data-lang="txt">N # Number of circles used
x_1 y_1 # coordinates of the center of circle 1
x_2 y_2
...
x_N y_N</code></pre>
</div>
</div>
<div class="paragraph">
<p>The circle radius will be the same for each circle and will be configurable with the option --radius at the program execution.</p>
</div>
</div>
<div class="sect2">
<h3 id="_phi_init"><a class="anchor" href="#_phi_init"></a>2.2. \phi init</h3>
<div class="paragraph">
<p>To initialize \phi, the file that contain circle coordinates will be read. We begin to write the associated equations of each circles ( noted \phi_i in the following example ), then we multipliy beetween them to finally obtain the unique equation of all the circles.</p>
</div>
<div class="paragraph">
<p>Example :</p>
</div>
<div class="paragraph">
<p>
\phi_1 = (x-x_1)^2 + (y-y_1)^2 - r^2 \\
\phi_2 = (x-x_2)^2 + (y-y_2)^2 - r^2 \\
...\\
\phi_N = (x-x_N)^2 + (y-y_N)^2 - r^2 \\
</p>
</div>
<div class="paragraph">
<p>whith</p>
</div>
<div class="ulist">
<ul>
<li>
<p>(x_i,y_i) coordinates of circle C_i for all i \in [1,N]</p>
</li>
<li>
<p>r the shared circle radius</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>After the multiplication, we have :</p>
</div>
<div class="paragraph">
<p>
\phi=\phi_1\times\phi_2\times...\times\phi_N
</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cpp hljs" data-lang="cpp">auto thefms = fms( Vh );
std::ifstream flux(soption(_name="circles")) ; std::ostringstream ostr;
int nbCircles ; flux &gt;&gt; nbCircles ;
for (int i = 0 ; i &lt; nbCircles ; i ++) {
    flux &gt;&gt; x_center ; flux &gt;&gt; y_center ;
    ostr &lt;&lt; "((x-" &lt;&lt; x_center*pixelsize &lt;&lt; ")^2+(y-" &lt;&lt; y_center*pixelsize &lt;&lt; ")^2-" &lt;&lt; radius*radius &lt;&lt; ")" ;
    if (i != nbCircles-1) ostr &lt;&lt; "*" ;
}
ostr &lt;&lt; ":x:y";
auto phi = Vh-&gt;element( expr( ostr.str() ) );</code></pre>
</div>
</div>
<div class="paragraph">
<p>However, this last action didn&#8217;t keep one of the properties of distance function : |\nabla\phi|=1, that&#8217;s why a redistance of \phi will be realise. This method already exists in the Feel++ library</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cpp hljs" data-lang="cpp">phi = thefms-&gt;march(phi) ;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_advection_velocity_calculation"><a class="anchor" href="#_advection_velocity_calculation"></a>2.3. Advection velocity calculation</h3>
<div class="paragraph">
<p>A quick reminder of the definiton of the advection velocity</p>
</div>
<div class="paragraph">
<p>
u=\beta=\frac{1}{1+\alpha|\nabla I|}\frac{\nabla\phi}{|\nabla\phi|}
</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cpp hljs" data-lang="cpp">auto beta = (1./(1.+alpha*sqrt(inner(gradv(px),(gradv(px)))))) * (trans(gradv(phi))/sqrt(inner(gradv
(phi),gradv(phi)))) ;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The class <em>ExtenderFromInterface</em> will be use to obtain the extend velocity u_e. This class take in main parameters a distance function and a velocity to extend :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cpp hljs" data-lang="cpp">efi.update(phi) ;
auto beta_x = Vh-&gt;element () ;
auto beta_y = Vh-&gt;element () ; beta_x.on(_range=elements(mesh), _expr=beta(0,0)) ;
beta_y.on(_range=elements(mesh), _expr=beta(1,0)) ; efi.extendFromInterface(beta_x) ;
efi.extendFromInterface(beta_y) ;
beta_p.on(_range=elements(mesh), _expr=vec(idv(beta_x), idv(beta_y))) ;</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>NOTE</strong> : We extend seperately the velocity u on its two components, because this velocity is a vectorial field and the method <em>extendFromInterface</em> can taken only scalar fields.</p>
</div>
</div>
<div class="sect2">
<h3 id="_stabilization_term_calcualtion"><a class="anchor" href="#_stabilization_term_calcualtion"></a>2.4. Stabilization term calcualtion</h3>
<div class="ulist">
<ul>
<li>
<p> \mathcal{L}(\phi)=\beta\cdot\nabla\phi + \sigma\phi</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cpp hljs" data-lang="cpp">auto L_op = inner(gradt(phi), trans(idv(beta_p))) + sigma*idt(phi);</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>supg\_term=\beta\cdot\nabla\psi</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cpp hljs" data-lang="cpp">auto supg_term = inner(grad(psi), trans(idv(beta_p))) ;</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>\tau=\frac{h}{2|\beta|}</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cpp hljs" data-lang="cpp">auto tau_supg = h() / max (2.*sqrt(inner(idv(beta_p), idv(beta_p))), umin*umin);</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_advection_equation_solve"><a class="anchor" href="#_advection_equation_solve"></a>2.5. Advection equation solve</h3>
<div class="ulist">
<ul>
<li>
<p>Bilinear form</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cpp hljs" data-lang="cpp">a = integrate( _range=elements(mesh), _expr=(sigma*idt(phi)+inner(trans(idv(beta_p)),gradt(phi)))*id(psi));
a += integrate (_range=elements(mesh), _expr=tau_supg*supg_term *L_op);</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Linear form</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cpp hljs" data-lang="cpp">l = integrate(_range=elements(mesh),
_expr=f*id(psi));
l += integrate(_range=elements(mesh),
_expr=tau_supg*supg_term*f);</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Equation solve</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cpp hljs" data-lang="cpp">a.solve(_rhs=l, _solution=phi) ;</code></pre>
</div>
</div>
<div class="paragraph">
<p>with f=\frac{\phi^n}{\Delta t}</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cpp hljs" data-lang="cpp">auto f = idv(phi)/dt ;</code></pre>
</div>
</div>
<div class="paragraph">
<p>and \sigma=\frac{1}{\Delta t}</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cpp hljs" data-lang="cpp">auto sigma = 1./dt ;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_redistance"><a class="anchor" href="#_redistance"></a>2.6. Redistance</h3>
<div class="paragraph">
<p>The result of the previous resolution is stored into \phi at each iteration. Then we need to redistance like at the initialisation.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cpp hljs" data-lang="cpp">phi = thefms-&gt;march(phi) ;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_stop_condition_2"><a class="anchor" href="#_stop_condition_2"></a>2.7. Stop condition</h3>
<div class="paragraph">
<p>We quit the loop when \phi^{n+1}-\phi^n &lt;  tolerance or if velocity u &lt;  tolerance</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cpp hljs" data-lang="cpp">while (mean_beta_x &gt; tolerance || mean_beta_y &gt; tolerance || erreurL2 &gt; tolerance) ;</code></pre>
</div>
</div>
<div class="paragraph">
<p>where</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cpp hljs" data-lang="cpp">mean_beta_x = mean(_range=elements(mesh), _expr=norm2(idv(beta_p)(0,0)))(0,0) ; mean_beta_y = mean(_range=elements(mesh), _expr=norm2(idv(beta_p)(1,0)))(0,0) ;
erreurL2 = normL2(_range=elements(mesh), _expr=idv(phi) - idv(phi_old)) ;</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_tests_and_results_2"><a class="anchor" href="#_tests_and_results_2"></a>3. Tests and results</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now that we have seen the theory, we will apply it into the following example, in which we will try to detect the edges of the red areas :</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../../../../Pictures/px_image.png" alt="px image">
</div>
</div>
<div class="paragraph">
<p>In order to detect them, we \"put\" two circles into our aeras of interest.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../../../../Pictures/px_surface_circle.png" alt="px surface circle">
</div>
</div>
<div class="sect4">
<h5 id="_test_1_reference_test_without_the_penality_term"><a class="anchor" href="#_test_1_reference_test_without_the_penality_term"></a>Test 1 : Reference test without the penality term</h5>
<div class="paragraph">
<p>Let&#8217;s begin to study a case where the advection velocity u=\frac{1}{1+\alpha|\nabla I|}\frac{\nabla\phi}{|\nabla I|} with \alpha=0, in other words whitout taking in account the penality term.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../../../../Pictures/alpha_0_1.png" alt="alpha 0 1">
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="../../../../../Pictures/alpha_0_2.png" alt="alpha 0 2">
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="../../../../../Pictures/alpha_0_3.png" alt="alpha 0 3">
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="../../../../../Pictures/alpha_0_4.png" alt="alpha 0 4">
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="../../../../../Pictures/alpha_0_5.png" alt="alpha 0 5">
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="../../../../../Pictures/alpha_0_6.png" alt="alpha 0 6">
</div>
</div>
<div class="paragraph">
<p>We can denote that the advection at the zero-level of the \phi function is propagated correctly.</p>
</div>
</div>
<div class="sect3">
<h4 id="_test_2_reference_test_with_the_penality_term"><a class="anchor" href="#_test_2_reference_test_with_the_penality_term"></a>3.2. Test 2 : Reference test with the penality term</h4>
<div class="paragraph">
<p>Now, we will observe the case where \alpha isn&#8217;t null, then the more |\nabla I| rise up, the more the velocity u decrease, until it become 0 when the velocity pass trough the thresold ( |u| &lt; u_{min} ).</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../../../../Pictures/alpha_1_1.png" alt="alpha 1 1">
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="../../../../../Pictures/alpha_1_2.png" alt="alpha 1 2">
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="../../../../../Pictures/alpha_1_3.png" alt="alpha 1 3">
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="../../../../../Pictures/alpha_1_4.png" alt="alpha 1 4">
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="../../../../../Pictures/alpha_1_5.png" alt="alpha 1 5">
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="../../../../../Pictures/alpha_1_6.png" alt="alpha 1 6">
</div>
</div>
<div class="paragraph">
<p>After observation of these pictures, especially the ones at t=0.07 and t=0.11, we can denote the edges influence on the propagation front. But, as the experience continue, we notice the fronts keep going on and break trough the edges we would like to detect. To try to fix this, we test different values for \alpha, u_{min} and the tolerance, but it still pass trough and lead the programm into an infinite loop, as the velocity u never reach 0.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../../../../Pictures/alpha_t07.png" alt="alpha t07">
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="../../../../../Pictures/alpha_t10.png" alt="alpha t10">
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="../../../../../Pictures/alpha_t11.png" alt="alpha t11">
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="../../../../../Pictures/alpha_t15.png" alt="alpha t15">
</div>
</div>
</div>
</div>
</div>
<h1 id="_holo3_server" class="sect0"><a class="anchor" href="#_holo3_server"></a>Holo3 Server</h1>
<div class="paragraph">
<p>Unfortunately, the Feel<code> library isn&#8217;t compatible with the Windows OS, that is the only one used by Holo3. That&#8217;s why Pierre Danieau ask me to install <em>Linux</em> and Feel</code> on their calculation server. The computations can be launch remotly with a ssh protocol.</p>
</div>
<div class="sect1">
<h2 id="_files_path"><a class="anchor" href="#_files_path"></a>1. Files path</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Source files :</p>
<div class="ulist">
<ul>
<li>
<p>Surface reconstruction</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>~/Documents/holo3/src/feelpp/surface_reconstruction/surface_rec.cpp</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Mesh extraction + surface reconstruction</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>~/Documents/holo3/src/feelpp/surface_reconstruction/ROI_surface_rec.cpp</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>GUI for areas selection</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>~/Documents/holo3/src/Qt/ROI_selection/</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>GUI for areas selection + mesh extraction + surface reconstruction</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>~/Documents/holo3/src/Qt/ROI_computation/</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Executable files</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>~/Documents/build/</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Example usage</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>mpirun -np 4 feelpp_ROI_surface_rec --hbf1 [chemin absolu vers px] --hbf2 [chemin absolu vers py] --polygon [chemin absolu vers le fichier de polygone] --exclusion false</pre>
</div>
</div>
</div>
</div>
<h1 id="_conclusion" class="sect0"><a class="anchor" href="#_conclusion"></a>Conclusion</h1>
<div class="paragraph">
<p>During my end-study stage from the Master CSMI at the Holo3 company, I had the opportunity to take in practice my mathematical knowledge, acquired during my formation, ans also improve my global understanding in computer software. In fact, I discovered and used new computer libraries, such as <em>Qt</em>, which help me to build the GUI, or <em>OpenCV</em> and <em>scliab</em>, that I use for .hbf images handling.
Holo3 have now a surface reconstruction tool in Feel++, that can be use on several processors. A GUI is also available to select the areas of interest we will extract to create a submesh where we will perform the surface reconstruction. Finally, a calculation server has been provide.</p>
</div>
<h1 id="_references" class="sect0"><a class="anchor" href="#_references"></a>References</h1>
<div class="ulist">
<ul>
<li>
<p><a href="http://www.holo3.com/" class="bare">www.holo3.com/</a></p>
</li>
<li>
<p><a href="http://www.feelpp.org/docs/">Feel++ Consortium</a></p>
</li>
<li>
<p>Vincent Doyeux. Modelisation et simulation de systemes multi-fluides. Application aux ecoulements sanguins. 2014.</p>
</li>
<li>
<p>Joseph Mure. Stage à Holo3. 2014.</p>
</li>
</ul>
</div>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>

  </div>
</main>
</div>
<footer class="footer">
  <div class="container">
    <div class="footer-links">
      <div class="col">
        <div class="footer-logo">
          <a href="https://www.cemosis.fr" class="icon">
            <img src="../../../../../_/img/logoCemosisTransparent.png" alt="Cemosis">
          </a>
        </div>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://docs.cemosis.fr" target="_blank" rel="noopener">Projects Documentation</a></li>
          <li><a href="https://join.slack.com/t/feelpp/shared_invite/zt-2qe0q9hw-4pVbhohCXUE6Po9Ma8dbiQ" target="_blank" rel="noopener">Forums(Slack)</a></li>
        </ul>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://www.cemosis.fr" target="_blank" rel="noopener">Cemosis</a></li>
          <li><a href="https://www.cemosis.fr/news" target="_blank" rel="noopener">News</a></li>
          <li><a href="https://www.cemosis.fr/projects" target="_blank" rel="noopener">Projects</a></li>
        </ul>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://docs.feelpp.org" target="_blank" rel="noopener">Feel++ Documentation</a></li>
          <li><a href="http://docs.feelpp.org/user/">Get Started</a></li>
          <li><a href="http://docs.feelpp.org/user//install/distributions/">Downloads</a></li>
        </ul>
      </div>
      <div class="col">
        <ul class="social-icons">
          <li>
            <svg  width="14" height="14" viewBox="0 0 32 32"> <path id="facebook" class="cls-1" d="M29,0H3A2.652,2.652,0,0,0,0,3V29a2.652,2.652,0,0,0,3,3H16V18H12V14h4V12a6.452,6.452,0,0,1,6-6h4v4H22a2.151,2.151,0,0,0-2,2v2h6l-1,4H20V32h9a2.652,2.652,0,0,0,3-3V3A2.652,2.652,0,0,0,29,0Z"/></svg>
            <a href="https://www.facebook.com/cemosis.fr" class="icon">
            Facebook
            </a>
          </li>
          <li>
            <svg  width="14" height="14" viewBox="0 0 32.1 26.1"> <path id="twitter" class="cls-1" d="M32,7.1a11.836,11.836,0,0,1-3.8,1,6.462,6.462,0,0,0,2.9-3.6,12.606,12.606,0,0,1-4.2,1.6A6.492,6.492,0,0,0,22.1,4a6.594,6.594,0,0,0-6.6,6.6,7.719,7.719,0,0,0,.2,1.5A18.458,18.458,0,0,1,2.2,5.2a6.294,6.294,0,0,0-.9,3.3A6.765,6.765,0,0,0,4.2,14a6.109,6.109,0,0,1-3-.8v.1a6.543,6.543,0,0,0,5.3,6.4,4.678,4.678,0,0,1-1.7.2,4.869,4.869,0,0,1-1.2-.1,6.679,6.679,0,0,0,6.1,4.6,12.917,12.917,0,0,1-8.2,2.8,9.151,9.151,0,0,1-1.6-.1,18.438,18.438,0,0,0,10.1,3c12.1,0,18.7-10,18.7-18.7v-.8A13.336,13.336,0,0,0,32,7.2Z" transform="translate(0.1 -4)"/></svg>
            <a href="https://twitter.com/cemosis" class="icon">
              Twitter
            </a>
          </li>
          <li>
          <svg  width="14" height="14" viewBox="0 0 32 32"> <path id="linkedin" class="cls-1" d="M29,0H3A3.076,3.076,0,0,0,0,3V29a3.009,3.009,0,0,0,3,3H29a2.946,2.946,0,0,0,3-3V3A3.009,3.009,0,0,0,29,0ZM12,26H8V12h4ZM10,10a2,2,0,1,1,2-2A2.006,2.006,0,0,1,10,10ZM26,26H22V18a2,2,0,0,0-4,0v8H14V12h4v2.5c.8-1.1,2.1-2.5,3.5-2.5A4.736,4.736,0,0,1,26,17Z"/></svg>
              <a href="https://www.linkedin.com/company/cemosis" class="icon">
             Linkedin
            </a>
          </li>
        </ul>
      </div>
    </div>
    <div class="footer-terms">
      <div class="footer-terms-copyright">
          <span>© 2020 Cemosis, Université de Strasbourg</span>
      </div>
      <div class="footer-terms-links">
        <a href="https://www.cemosis.fr/terms-of-use">Terms of Use</a>
        <a href="https://www.cemosis.fr/privacy-policy">Privacy Policy</a>
        <a href="https://www.cemosis.fr/cookie-policy">Cookie Policy</a>
        <a href="https://www.cemosis.fr/support-policy">Support Policy</a>
      </div>
    </div>
  </div>
</footer>
<script src="../../../../../_/js/site.js"></script>
<script async src="../../../../../_/js/vendor/fontawesome-icon-defs.js"></script>
<script async src="../../../../../_/js/vendor/fontawesome.js"></script>
<script async src="../../../../../_/js/vendor/highlight.js"></script>

<script async id="search-script" src="../../../../../_/js/vendor/docsearch.js" data-app-id="FIPLENFG5M" data-api-key="489d96aa4ae574ec7ad1f23741a2d46d" data-index-name="cemosis" data-stylesheet="../../../../../_/css/vendor/docsearch.css">
</script>

  </body>
</html>
